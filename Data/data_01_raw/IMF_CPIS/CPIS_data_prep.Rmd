---
title: "FDI"
author: "Yingjie"
date: "`r Sys.Date()`"
output: html_document
---


# Set up
```{r Paths and packages, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### To clear your environment 
remove(list = ls())

### set work dir
path <- rstudioapi::getSourceEditorContext()$path
dir  <- dirname(rstudioapi::getSourceEditorContext()$path); dir
getwd()

### data path 
source('./Code/_path of data.R')


### packages
source('./Code/_package list.R')
source('./Code/function_scatter_plot.R')

```


# Data

## Ancillary data
```{r}

### extended country-iso3 pair list for matching
load('./Data/Ancillary_Data_iso_eora_ex.RData')  ## ## iso_eora_ex


### use the Eora data as the template 
f <- paste0('./Data/data_02_intermediate/dt02_flows/', 'template_eora.RData')
load(f) # `temp_eora`
```



## CPIS

  The *Coordinated Portfolio Investment Survey* (CPIS) is a voluntary data collection exercise conducted under the auspices of the IMF. 
  The CPIS is a voluntary data collection exercise that assembles data on countries' international holdings of equities and long- and short-term debt securities.39 Countries report data on (i) their holdings of portfolio investment assets issued by residents in other countries and (ii) their portfolio investment liabilities issued by domestic residents and held by residents in other countries. The data are reported at the bilateral country-to-country level for all sectors. 

```{r - preprocessing}
### get the indicator name
ind <- 'CPIS'

library(countrycode)

yrs <- c(2000, 2005, 2010, 2015)
yrs <- c(2000, 2005, 2010, 2015, 2021)

cc <- load(paste0(dir.cpis,'codelist_panel.rda'))

f <- paste0(dir.cpis, 'CPIS_12-16-2024 19-54-07-13_timeSeries.csv'); f

df <- readr::read_csv(file = f, show_col_types = F) %>%
  dplyr::rename(
    o_name = `Country Name`, 
    o_code = `Country Code`,
    d_name = `Counterpart Country Name`, 
    d_code = `Counterpart Country Code`
  ) %>%
  select(-contains('Sector'))  %>%
  select(1:`2023`) %>%
  filter(!`Indicator Code` %in% c('I_L_T_T_T_BP6_DV_USD', 'I_L_T_T_T_BP6_USD'))

names(df)

# unique(df$`Counterpart Sector Name`)
unique(df$Attribute)
distinct(df, `Indicator Name`, `Indicator Code`)

df_ <- df %>%
  filter(Attribute == "Value") %>%
  select(-Attribute) %>%
  filter(`Indicator Code` %in% c('I_A_T_T_T_BP6_USD'))

distinct(df_, `Indicator Name`, `Indicator Code`)

dfl <- df_ %>%
  as.data.frame() %>%
  select(-contains('Indicator'))  %>%
  mutate_if(is.numeric, as.character) %>%
  pivot_longer(cols = `1997`:`2023`, names_to = 'year', values_to = 'value') %>%
  mutate(value = as.numeric(value)) %>%
  ## check data 
  # filter(o_name == 'Germany', year == 2020) %>%
  as.data.frame()
```


```{r - preprocessing - country code}

ctr_list1 <- df %>% distinct(o_name, o_code) %>%
  dplyr::rename(name = o_name, 
                code = o_code)
ctr_list2 <- df %>% distinct(d_name, d_code) %>%
  dplyr::rename(name = d_name, 
                code = d_code)

## convert country code using https://github.com/vincentarelbundock/countrycode
ctr_list <- rbind(ctr_list1, ctr_list2) %>%
  distinct() %>%
  mutate(
    code = as.numeric(code),
    iso = countrycode(code, origin = 'imf', destination = "iso3c")) %>%
  select(1:code, iso, everything()) %>%
  arrange(!is.na(iso))


## clean the data 
iso3_code <- iso_eora_ex %>% dplyr::select(-IMF)
  

ctr_list_na <- ctr_list %>%
  filter(is.na(iso)) %>%
  select(-iso) %>%
  dplyr::mutate(name = gsub('\\.|\\:|\\,', '', name)) %>%
  left_join(x = .,
          y = iso3_code,
          by=c('name' = 'Row')) %>%
  dplyr::rename("iso" = "iso3_eora") %>%
  arrange(!is.na(iso)) 

ctr_code1 <- ctr_list %>% filter(!is.na(iso))
ctr_code2 <- ctr_list_na %>% filter(!is.na(iso))
ctr_code <- rbind(ctr_code1, ctr_code2) %>%
  select(-name)
```


```{r - preprocessing}

dt <- dfl %>%
  mutate(o_code = as.numeric(o_code),
         d_code = as.numeric(d_code) ) %>%
  left_join(x = .,
            y = ctr_code,
            by=c('o_code' = 'code')) %>%
  dplyr::rename("o_iso" = "iso") %>%
  select(1:o_code, o_iso, everything()) %>%
  left_join(x = .,
            y = ctr_code,
            by=c('d_code' = 'code')) %>%
  dplyr::rename("d_iso" = "iso") %>%
  select(1:d_code, d_iso, everything())


```







```{r - final üìÅ}
## use both data to further clean the dataset 
dcomp_ <- d1 %>%
  left_join(., d2, 
            by = c("year","iso3","to")) %>%
  dplyr::select(year, iso3, to, everything()) %>%
  dplyr::mutate(value = case_when(
    !is.na(value_in) & is.na(value_out)  ~ value_in,
    is.na(value_in) & !is.na(value_out)  ~ value_out,
    !is.na(value_in) & !is.na(value_out) ~ (value_in + value_out)/2,
    T ~ NA
  )) %>%
  dplyr::select(-value_in,-value_out)


## format as the same as EORA data
dfs_flow_f <- dcomp_ %>%
  dplyr::mutate(value = value * 10^6) %>%   ## change the unit to USD
  dplyr::select(year, iso3, everything()) %>%
  
  ## use data in 2009 to represent data in 2005
  dplyr::mutate(year = ifelse(year == 2009, 2005, year)) %>%
  dplyr::filter(year %in% yrs) %>%
  
  ## the template can limit the years included 
  merge(x = temp_eora, 
        y = ., 
        by.x = c('year', 'iso3', 'to'), 
        by.y = c('year', 'iso3', 'to'), all.x = T) %>%
  as.data.frame()



### To generate the same format as Eora in Matrix
df_formatted <- dfs_flow_f %>%
  ungroup() %>%
  arrange(year, iso3, to) %>%
  dplyr::select(year, ctr, everything()) %>%
  spread(key = to, value = value) %>%
  arrange(year, iso3)


### save to the `eora_cleaned` folder --------------------------------------------------------------
df_formatted %>%
  group_by(year) %>% tally()
fname <- paste0(dir.eora_cleaned, ind, '_matrix.xlsx'); fname
writexl::write_xlsx(x = df_formatted, path = fname)
```





