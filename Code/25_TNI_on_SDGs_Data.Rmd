---
title: "Spillover on SDGs"
author: "Yingjie Li"
date: "2021-03-01 (Updated: 2021-03-04)"
output: pdf_document
editor_options: 
  chunk_output_type: inline
---


# Set up
```{r Dirs and packages, include=FALSE}

### To clear your environment 
remove(list = ls())

### set work dir
path <- rstudioapi::getSourceEditorContext()$path
dir  <- dirname(rstudioapi::getSourceEditorContext()$path); dir
setwd(dir)
setwd('..') # set directory by one folder up
getwd()


### data path
source('./Code/_path of data.R')
dir.input1 <- dir.cleaned       ## data for country profile, which are cleaned 
dir.input2 <- dir.flowScenario  ## data for no_trade, no_dst_trade, no_nearby_trade scenarios
dir.output <- './Data/data_03_results/'



### packages
source('./Code/_package list.R')


library(Rmisc) ## for `summarySE`
library(tmap)
library(RColorBrewer)

## data package
library(wbstats)
library(FAOSTAT)
## https://github.com/expersso/WHO
# From Github
# library(devtools)
# install_github("expersso/WHO")
library(WHO)


### Disable Scientific Notation in R
options(scipen = 999) # Modify global options in R

today <- format(Sys.time(), "%Y%m%d"); today
```



```{r Theme and font}
theme_set(theme_bw())

### plot settings
unit_ns    <- 'cm'
width_1col <- 8.8   ## 1-column
width_2col <- 18    ## 2-column
font       <- 'sans'     ## "TT Arial"
font_size  <- 8          ##  Nature Sustainability: max = 7; min = 5
theme_ns <- 
  theme_bw()+
  theme(
    # axis.title =element_blank(),
    # axis.text  =element_blank(),
    # axis.ticks =element_blank(),
    # panel.background = element_rect(fill = NA),
    # panel.grid.major.x = element_blank(),
    # panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.background = element_rect(fill="transparent"),
    legend.key.size = unit(0.15,"cm"),
    text = element_text(size=font_size)
        )

theme_map <- theme(
    axis.title =element_blank(),
    axis.text  =element_blank(),
    axis.ticks =element_blank(),
    panel.background = element_rect(fill = NA),
    panel.grid  = element_blank())
```


```{r Functions}
### normalization using the function
### Rather than just dropping the top and bottom trim percent, these extreme values are replaced with values at the trim and 1- trim quantiles. See more at https://rdrr.io/cran/psych/man/winsor.html
### We added one more step of this data processing than Xu and Li et al 2020 in NS. 
source("./Code/function_norm_sdg_score_good_bad.R")


### to plot the initial value of SDG indicator for data checking 
source('./Code/helper_func_plot_map.R')

```


  The upper and lower bounds for normalization. 
  Here, we use the bounds by SDSN 2021. 
  
  *Note: * we do NOT use this, because there are few indicator overlap between this study and the SDSN reports. The data here might be useful for future rebuttal to reviewers. 

```{r Bounds}
getwd()
xls <- 'https://dashboards.sdgindex.org/static/downloads/files/SDR%202021%20-%20Database.xlsx'
xls <- 'G:/Shared drives/gdrive/_paper/SDGs/Refs/SDSN Reports/SDR2021/SDR 2021 - Database.xlsx'
b <- readxl::read_excel(path = xls, sheet = 'Codebook') %>%
  dplyr::select(IndCode, SDG, Global, Indicator, `Optimum (= 100)`, 
                `Lower Bound (=0)`, `Justification for Optimum`, Description) %>%
  dplyr::rename(Upper_100 = `Optimum (= 100)`, 
                Lower_0   = `Lower Bound (=0)`)

names(b)

writexl::write_xlsx(x = b, path = './Data/_SDG_ind_upper_lower_bounds.xlsx')

Note1 <- "please refer to `_SDG_ind_upper_lower_bounds_edited.xlsx` -- but still need to edit."
```



## Ancillary data

**FT data**
  Outsourced footprints embodied in net imports. 
  
  This data was generated by `22_10_TNI.Rmd` and `22_20_TNI_dst_ner.Rmd`. 

```{r FT data -- choose input ❓}

### load 1: trade vs no-trade scenarios
ls_f <- list.files(path = dir.input2, pattern = '^net_imports_fromAll', full.names = T); 
# ls_f
f <- tail(ls_f, n = 1); cat('\n Here, we load this version as input: \n\t', f, '\n\n')
load(file = f) ## load the latest data `net_imports_fromAll`


### load 2: distant trade vs. nearby trade scenarios
ls_f <- list.files(path = dir.input2, pattern = '^net_imports_fromDst_fromNer', full.names = T); 
# ls_f
f <- tail(ls_f, n = 1); cat('\n Here, we load this version as input: \n\t', f, '\n\n')
load(file = f) 


### combine 
net_imports_bind <- rbind(net_imports_fromAll, net_imports_fromDst_fromNer) 

###' Need to specify the number of year's data included in the analysis 
###' This can ensure all other data considered are in the same time frame. 
yrs <- unique(net_imports_bind$year)
```



```{r Pop gdp shp}
load('./Data/Ancillary_Data_ISO3code_shp.RData') ## `iso_eora`, `pop`, `gdp` (USD), `shp`, `grp`
pop_l <- pop %>% as.data.frame() %>%
  gather(key = 'year', value = 'pop', `2000`:ncol(.)) %>%
  dplyr::select(-ctr) %>%
  as.data.frame()


mark <- 'option2Chung'
shp_ctr_list <- grp_update %>% 
  dplyr::mutate(
    group = tm::removeNumbers(group_income2),
    group = factor(x = group, levels = c("High income", "Low income")),
    group = fct_rev(group)
    ) %>%
  as.data.frame()


### extended country-iso3 pair list for matching
load('./Data/Ancillary_Data_iso_eora_ex.RData')  ## `iso_eora_ex`

### shp data for WIOD country list -------------------------------------------------------------
pattern <- paste0('shp_wiod.RData'); pattern
fname <- list.files(path = 'D:/_papers/SDGs/SDGs_Global_Trade', recursive = T, full.names = T, pattern = pattern); fname
load(fname)
names(shp_wiod) <- c("ADM0_A3", "NAME", "iso_a3", "geometry")
```


```{r Total workers}
xls <- list.files(path = dir.input1, pattern = '^workers_thousands', full.names = T); xls 
total_workers <- readxl::read_excel(path = xls) %>% 
  as.data.frame() %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'total_workers', `2000`:ncol(.)) %>%
  dplyr::mutate(total_workers = as.numeric(total_workers)) %>%
  as.data.frame()


xls <- list.files(path = dir.input1, pattern = '^Labor force, total', full.names = T); xls 
total_labor <- readxl::read_excel(path = xls) %>% 
  as.data.frame() %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'total_workers', `2000`:ncol(.)) %>%
  dplyr::mutate(total_workers = as.numeric(total_workers),
                total_workers = total_workers/1000) %>% 
  as.data.frame()
```



```{r Land}
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Land area', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
land_total <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'land_total_km2', `2000`:ncol(.)) %>%
  as.data.frame()

ctr_eora_list <- land_total %>%
  distinct(iso3)
```


  GDP can be determined in three ways, all of which should, theoretically, give the same result. They are the production (or output or value added) approach, the income approach, or the speculated expenditure approach. It is representative of the total output and income within an economy
  
  In the *expenditure approach*, GDP (Y) is the sum of consumption (C), investment (I), government spending (G) and net exports (X – M), i.e., Y = C + I + G + (X − M). 
  
  Thus, if there were no trade, gdp* = gdp - net_exports = gdp + net_imports
```{r GDP}
ind_sdg    <- 'gdp' ## USD
ind_ft     <- 'GDP' 
unit_check <- 1

### Check the Unit!!!
### rel --> USD
### oft --> USD
### gdp --> USD

rel_w <- gdp ## the status data 

rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'gdp', `2000`:ncol(.)) %>%
  dplyr::mutate(gdp = gdp*unit_check) %>%
  as.data.frame()


### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind     = unique(oft$ind),
    gdp_rel = (gdp +      0),
    gdp_not = (gdp + fromAll),      ## if no       trade,                     gdp* = gdp + (net_imports from all countries)
    gdp_dst = (gdp + fromNer),      ## if only dst trade(i.e., no ner trade), gdp* = gdp + (net_imports from ner countries) 
    gdp_ner = (gdp + fromDst)) %>%  ## if only ner trade(i.e., no dst trade), gdp* = gdp + (net_imports from dst countries) 
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, gdp, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, gdp_rel, gdp_not, gdp_dst, gdp_ner)

gdp_rel_not <- rel_not %>%
  dplyr::select(-ind)
```



```{r GNI}
### load GNI data
f <- paste0(dir.cleaned, 'GNI, Atlas method (current US$)_4yrs.xlsx')
gni <- readxl::read_excel(f) %>%
  as.data.frame()

### compare GNI vs GDP
gni_gdp <- merge(
  x = gni, 
  y = gdp, 
  by = c('iso3', 'ctr')
) %>%
  ggplot(aes(x = `2015.x`, y = `2015.y`)) +
  geom_point() +
  geom_abline(slope = 1, color = 'red') +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  xlab('GNI') + ylab('GDP') +
  theme_bw()
gni_gdp
```


# ========================================================================================
#  Data 

##  SDG score and the Impacts

### SDG 1

####  - 1.1.1 Poverty population
  1.1.1 Proportion of the population living below the international poverty line
  
```{r}
ind_sdg <- 'Poverty Proportion'
ind_ft  <- 'Poverty' 
unit_check <- 1
unit_ind   <- 'Percent'
direction_sdg <- -1


### Check the Unit!!!
### rel         --> % of population
### oft         --> 1 people
### total pop_l --> 1 people


### Resource consumption or emissions under the current trading world situation ----------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Poverty headcount', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = pop_l,  by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = oft,    by = c('iso3', 'year'), all.x = T) %>% 
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    net_ex    = - fromAll,        ## number of employment at poverty associated with exports
    value_rel = (value + 0), 
    ## if no trade, an exporter would reduce the number of people at poverty (i.e., 'net_ex')
    value_not = (value/100*pop - net_ex)/(pop)*100,
    value_dst = (value/100*pop - (-fromNer))/(pop)*100,
    value_ner = (value/100*pop - (-fromDst))/(pop)*100
    ) %>%  
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_1_1_1 <- df_score

```

####  - 1.2.1 Poverty line

  *SDG*
    - 1.2.1 Proportion of population living below the national poverty line, by sex and age
  
  *SHDB*
    - 1.B Poverty - 1.B.a Percent of population living under the relevant poverty line
  
```{r}
ind_sdg <- 'Poverty line Proportion'
ind_ft  <- 'SHDB2_1Ba' 
direction_sdg <- -1


### Check the Unit!!!
### rel         --> 10^3 people
### oft         --> 10^3 people
### total pop_l --> 1    people


### Resource consumption or emissions under the current trading world situation ----------
###' to use EORA-SHDB data
###' use the row sum based on EORA data, total pop at risk
f <- paste0(dir.eora_cleaned, ind_ft, '.xlsx')
rel <- readxl::read_excel(f) %>%
  ## for SHDB data, we use 2019 for 2015 because of data gap
  dplyr::mutate(year = ifelse(year == 2019, 2015, year)) %>%
  gather(key = 'd', value = 'value', 4:ncol(.)) %>%
  group_by(year, iso3, ctr) %>%
  dplyr::summarise(value = sum(value, na.rm = T)) %>%
  ## given most of the data in Greenland is missing, we set it as NA
  dplyr::mutate(value = ifelse(iso3 =='GRL', NA, value)) %>%
  dplyr::select(-ctr)
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = pop_l,  by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = oft,    by = c('iso3', 'year'), all.x = T) %>% 
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value)/(pop/1000), 
    ##' if no trade, an exporter would reduce the number of people at poverty 
    ##' i.e., (-fromAll) = number of employment with poverty risk associated with exports
    value_not = (value - (-fromAll))/(pop/1000),
    value_dst = (value - (-fromNer))/(pop/1000),
    value_ner = (value - (-fromDst))/(pop/1000)
    ) %>%  
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_1_2_1 <- df_score
```


### SDG 2

  2.4.1 Proportion of agricultural area under productive and sustainable agriculture
  
```{r - 2.4.1 cropland/total land}
ind_sdg  <- 'cropland_percent' ## m2/m2
unit_check <- 1
direction_sdg <- -1 ## more is good or bad ???

### Check the Unit!!!
### rel --> ha
### oft --> ha
### total  --> km2


### Resource consumption or emissions under the current trading world situation --------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Arable land', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()


### --> cropland (ha)
xls <- list.files(path = dir.input1, pattern = '^Cropland_area', full.names = T); xls 
cropland_area <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'cropland_area', `2000`:ncol(.)) %>%
  dplyr::mutate(cropland_area = cropland_area*1000) %>%   ## 1000 ha --> ha
  as.data.frame()
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'Landusecrop') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = land_total,  by = c('iso3', 'year'), all.x = T) %>% ## total land
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)/(land_total_km2*100), ## 
    value_not = (value + fromAll)/(land_total_km2*100), ## cropland area under no-trade
    value_dst = (value + fromNer)/(land_total_km2*100),
    value_ner = (value + fromDst)/(land_total_km2*100)
    ) %>%  
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_2_4_1 <- df_score


temp <- df_score %>% head(2) %>%
  dplyr::mutate(ind = 'test', year = 2015, val = 1, value_norm = 50)
temp[2,4] <- 'value_not'
```

  
  2.1.2 Prevalence of moderate or severe food insecurity in the population, based on the Food Insecurity Experience Scale (FIES)
```{r - 2.1.2 Cereals_ton}
ind_sdg <- 'Cereals_ton per person'
ind_ft  <- 'Cereals_net_Import' 
unit_check <- 1
unit_ind   <- 'kg per capita per year'
direction_sdg <- 1

### Check the Unit!!!
### rel --> ton = 1000 kg
### oft --> 
### total pop --> 1


### Resource consumption or emissions under the current trading world situation --------------------
xls <- list.files(path = dir.input1, pattern = '^Cereals_Production', full.names = T); xls 
total_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
total_Cereals <- total_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'total_Cereals', `2000`:ncol(.)) %>%
  dplyr::mutate(total_Cereals = total_Cereals*1000) %>%  
  as.data.frame()
  

### net imported footprints ------------------------------------------------------------------------
### --> (this is the data from FAO food balance, which lacks bilateral trade info)
# xls1 <- list.files(path = dir.input1, pattern = '^Cereals_Import', full.names = T); xls1 
# xls2 <- list.files(path = dir.input1, pattern = '^Cereals_Export', full.names = T); xls2 
# import <- readxl::read_excel(xls1) %>% gather('year', 'import', 3:6)
# export <- readxl::read_excel(xls2) %>% gather('year', 'export', 3:6)
# oft    <- merge(import, export, by = c('iso3', 'ctr', 'year'), all = T) %>%
#   dplyr::mutate(net_in = import - export,
#                 ind    = ind_ft)%>%
#   dplyr::select(ind, year, iso3, net_in)

### --> now we switch to use the food trade matrix data 
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'TradeMatrix_Cereals') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- total_Cereals %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::rename(value = total_Cereals) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value + fromAll)/pop,   ## production + net imports = available food
    value_not = (value +       0)/pop,
    value_dst = (value + fromNer)/pop,
    value_ner = (value + fromDst)/pop) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner) %>%
  as.data.frame()

hist(rel_not$value_rel, xlab = unit_ind)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_2_1_2 <- df_score
```

  

### SDG 3
  3.9.1 Mortality rate attributed to household and ambient air pollution ( --> ton of PM25 per km2)
```{r - 3.9.1 PM25/total land}
ind_sdg  <- 'PM25_concentration' ## ton/km2
unit_check <- 1000
direction_sdg <- -1

### Check the Unit!!!
### rel --> kt = 1000 ton
### oft --> ton
### total  --> km2


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^PM25', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value),
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'PM25') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = land_total,  by = c('iso3', 'year'), all.x = T) %>% ## total land
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value + 0)/(land_total_km2*100),           ## 
    value_not = (value + fromAll)/(land_total_km2*100),
    value_dst = (value + fromNer)/(land_total_km2*100),
    value_ner = (value + fromDst)/(land_total_km2*100)
    ) %>%  ## cropland area under no-trade
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_3_9_1 <- df_score
```


  3.9.1 Mortality rate attributed to household and ambient air pollution ( --> ton of SO2 per km2)

```{r - 3.9.1s SO2/total land}
ind_sdg  <- 'SO2_concentration' ## ton/ha
unit_check <- 1000
direction_sdg <- -1

### Check the Unit!!!
### rel --> kt = 1000 * ton
### oft --> ton
### total  --> km2 = 100 * ha


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^SO2', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value),
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'SO2') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = land_total,  by = c('iso3', 'year'), all.x = T) %>% ## total land
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value + 0)/(land_total_km2*100),           ## 
    value_not = (value + fromAll)/(land_total_km2*100),
    value_dst = (value + fromNer)/(land_total_km2*100),
    value_ner = (value + fromDst)/(land_total_km2*100)
    ) %>%  ## cropland area under no-trade
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_3_9_1s <- df_score
```




  3.4.1 Mortality rate attributed to cardiovascular disease, cancer, diabetes or chronic respiratory disease
  
  * There are several data sources. 
    - *Total NCD Deaths (in thousands)_4yrs.xlsx*,  from WHO, include many NCD-related death. 
    - *NCD_death_number_of_person_4yrs.xlsx*,       from Min Gon, focus on red and processed meat trade. We chose this one because the trade-related matrix data are available too. 
    
```{r - 3.4.1 Mortality NCD}
ind_sdg    <- 'Mortality rate - NCD'
ind_ft     <- 'TradeMatrix_NCD_death_number' 
unit_check <- 1
unit_ind   <- 'death per million people'
direction_sdg <- -1

### Check the Unit!!!
### rel       --> 1 people of death
### oft       --> 1 people of death
### total pop --> 1 people


### Resource consumption or emissions under the current trading world situation --------------------
# xls <- list.files(path = dir.input1, pattern = '^Total NCD Deaths', full.names = T); xls
# rel <- readxl::read_excel(path = xls) %>% as.data.frame() %>%
#   dplyr::select(-ctr) %>%
#   gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
#   dplyr::mutate(value = value*1000) %>%
#   as.data.frame()
#
# 
# ### w/o trade, and with trade together  ------------------------------------------------------------
# rel_not_merge <- rel %>%
#   merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
#   merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
#   dplyr::mutate(
#     ind       = unique(oft$ind),
#     value_rel = (rel +      0)/pop,
#     value_not = (rel - net_in)/pop) %>% ## few imports, few death
#   dplyr::select(ind, iso3, year, net_in, everything())


xls <- list.files(path = dir.input1, pattern = '^NCD_death', full.names = T, recursive = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame() 
rel   <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value),
                value = value*unit_check) %>%  
  as.data.frame()



oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


rel_not_merge <- rel %>%
  # merge(x = land_total %>%  distinct(iso3, year), y = ., by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value)/pop,
    value_not = (value - fromAll)/pop,     ## few imports, few death
    value_dst = (value - fromNer)/pop,
    value_ner = (value - fromDst)/pop
    ) %>% 
  dplyr::select(ind, iso3, year, value, everything())



rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner) %>%
  as.data.frame()

hist(rel_not$value_rel, xlab = unit_ind)


### test, if the calculation match Figure 3b in BMJ paper by Chung, Min et al 2021 -----------------
### --> yes!
rel_not_merge_shp <- rel_not_merge %>%
  merge(x = shp, y = ., by.x = "iso_a3", by.y = "iso3",  all.y = T) %>%
  dplyr::filter(year == 2015)

### any countries failed to be joined? --> ANT, SUN, SUN --> which are expected. 
rel_not_merge_shp_na <- rel_not_merge_shp %>%
  dplyr::filter(is.na(name))

ggplot(data = rel_not_merge_shp) +
  geom_sf(aes(fill = fromAll/pop*10^6), size = 0.1) +
  scale_fill_distiller(palette = "Reds", direction = 1, 
                     name = 'net death_NCD_imports/million pop',
                     na.value = "grey95") +
  theme_bw() +
  ggtitle('NCD death per million people due to red and processed meat trade in 2015') +
  theme_map
  
  

### normalization  ---------------------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_3_4_1 <- df_score
```





### SDG 4

#### - 4.1.2 Children out of School

*SDG*
  4.1 By 2030, ensure that all girls and boys complete free, equitable and quality primary and secondary education leading to relevant and effective learning outcomes
  
  4.1.2 Completion rate (primary education, lower secondary education, upper secondary education) 
  
*SHDB*
  5.C Children out of School - 5.C.c Percent of Children Out of Primary School, total	
  
```{r}
ind_sdg <- 'Children out of School'
ind_ft  <- 'SHDB23_5Cc' 
direction_sdg <- -1


### Check the Unit!!!
### rel         --> 10^3 people
### oft         --> 10^3 people
### total pop_l --> 1    people


### Resource consumption or emissions under the current trading world situation ----------
###' to use EORA-SHDB data
###' use the row sum based on EORA data, total pop at risk
f <- paste0(dir.eora_cleaned, ind_ft, '.xlsx')
rel <- readxl::read_excel(f) %>%
  ## for SHDB data, we use 2019 for 2015 because of data gap
  dplyr::mutate(year = ifelse(year == 2019, 2015, year)) %>%
  gather(key = 'd', value = 'value', 4:ncol(.)) %>%
  group_by(year, iso3, ctr) %>%
  dplyr::summarise(value = sum(value, na.rm = T)) %>%
  ## given most of the data in Greenland is missing, we set it as NA
  dplyr::mutate(value = ifelse(iso3 =='GRL', NA, value)) %>%
  dplyr::select(-ctr)
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = pop_l,  by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = oft,    by = c('iso3', 'year'), all.x = T) %>% 
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value)/(pop/1000), 
    ##' if no trade, an exporter would reduce the number of people at risk 
    ##' i.e., (-fromAll) = number of employment with out-of-school risk associated with exports
    value_not = (value - (-fromAll))/(pop/1000),
    value_dst = (value - (-fromNer))/(pop/1000),
    value_ner = (value - (-fromDst))/(pop/1000)
    ) %>%  
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_4_1_2 <- df_score
```  
  
  

#### - 4.7.1 student_flow - outflow

  4.7.1 Extent to which (i) global citizenship education
  
  **NNED ATTENTION!!!**
    *which is good? net receiving or net sending? or both? and 0 is bad?* --> both.
    *Is there a need to divide population number?* --> yes. 
    
  (1) out-flow/pop: the more the better - engagement --> we used this as an indicator
  (2)  in-flow/pop: the more the better - openness
  
  **comments**
  - to use total population or use `School enrollment, tertiary_population`
  
```{r}
ind_sdg    <- 'student_flow' ## person
ind_ft     <- 'student_flow'
unit_check <- 1
direction_sdg <- 1

### Check the Unit!!!
### rel --> 
### oft --> person

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::select(ind, year, iso3, total_ex, total_in) %>%
  dplyr::select(ind, year, iso3, total_ex, scenario) %>%
  spread(key = scenario, value = total_ex) %>%
  as.data.frame()

length(unique(oft$iso3))

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- oft %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    # value_ex  = total_ex/pop,  ## net exports as the measurement
    # value_in  = total_in/pop,
    value_rel = fromAll/pop,     ## more out-flow, the better
    value_not = 0.1/pop,         ## 0 transfer under no-trade ## use 0.1 avoid 0, which cause problem in calculation later
    value_dst = fromNer/pop,
    value_ner = fromDst/pop) %>%   
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  --------------------------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_4_7_1 <- df_score
```


####  - 4.7.1s student_flow - inflow

```{r}
ind_sdg    <- 'student_flow_in' ## person
ind_ft     <- 'student_flow'
unit_check <- 1
direction_sdg <- 1

### Check the Unit!!!
### rel --> 
### oft --> person

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, total_in, scenario) %>%
  spread(key = scenario, value = total_in) %>%
  as.data.frame()

length(unique(oft$iso3))

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- oft %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = fromAll,     ## more out-flow, the better
    value_not = 0.1,         ## 0 transfer under no-trade ## use 0.1 avoid 0, which cause problem in calculation later
    value_dst = fromNer,
    value_ner = fromDst) %>%   
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  --------------------------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_4_7_1s <- df_score
```


### SDG 5

#### - XXX 5.5.2 Proportion of women in managerial positions  

  (1) 1st way to use World Bank data (TBD - NOT IN USE now) 

```{r}

ind_sdg <- 'Proportion of women in managerial positions'
ind_ft  <- 'SHDB15_3Bf' 
##' Risk of Gender inequality by Sector based on representation in the workforce; 
##' or 3.B.f Female Representation in the Workforce by Sector 
unit_check <- 1
unit_sdg   <- '%'
direction_sdg <- 1

### Check the Unit!!!
### rel --> %
### ft  --> 10^3 ppl
### total workers --> 10^3 ppl


### Resource consumption or emissions under the current trading world situation --------------------
xls <- list.files(path = dir.input1, pattern = '^Proportion of women in managerial', full.names = T); xls
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value),
                value = value) %>%
  as.data.frame()


### Total workers in a country
# xls <- list.files(path = dir.input1, pattern = '^workers_thousands', full.names = T); xls 
# total_workers


### Outsourced footprints (oft) flow -----------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  dplyr::mutate(net_in = ifelse(year == 2000, NA, net_in)) %>%  ## for SHDB data only, as no data for 2000
  spread(key = scenario, value = net_in) %>%
  arrange(ind, iso3, year)



### w/o trade, and with trade together  --------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = total_workers, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = ind_ft,
    value_rel = (value*total_workers)/(total_workers + 0), 
    ## % of female in managerial positions; +1 to avoid calculation error
    ##' `fromAll` (net imports) is the risk of non-female, 
    ##' which can be seen as "the number of male" - the higher the worse
    value_not = (value*total_workers)/(total_workers - fromAll)*100,
    value_dst = (value*total_workers)/(total_workers - fromNer)*100,
    value_ner = (value*total_workers)/(total_workers - fromDst)*100) %>% 
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())


### --> previous way to calculate this 
# rel_not_merge0 <- rel %>%
#   merge(x = ., y = total_workers, by = c('iso3', 'year'), all.x = T) %>%
#   merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>%
#   dplyr::mutate(
#     ind       = unique(oft$ind),
#     value_rel = (value +      0), ## % of female
#     ## 'net_in' is the risk of non-female, which can be seen as "the number of male" - the higher the worse
#     male_rel = (1-value/100)*total_workers, 
#     ## for an exporter, the risk of this indicator = being a male; if no trade, then less risk
#     net_exp  = - fromAll,
#     ## to calculate the number of male if no trade
#     male_not = male_rel - net_exp, ## if no trade, then less risk
#     ## to calculate the number of female under no-trade assumption
#     value_not = (total_workers - male_not)/total_workers*100) %>% ## net_in is a risk
#   ### for easy-checking the numbers
#   dplyr::select(-male_rel, -male_not, -net_exp) %>%
#   dplyr::select(ind, iso3, year, value, everything())


rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

### ! Un-comment the following line to include this indicator in the final analysis 
# score_5_5_2x <- df_score



### plot to compare ----------------------------------------------------------------------
helper_func_plot_map(data = rel_not, var = 'value_rel', yr = 2015, filename_postfix = paste0(ind_sdg, '_1'))
```



#### - 5.5.2 Proportion of women in managerial positions  

  (2) Using data from EORA

```{r}

ind_sdg <- 'Proportion of women in managerial positions'
ind_ft  <- 'SHDB15_3Bf' 
##' Risk of Gender inequality by Sector based on representation in the workforce; 
##' or 3.B.f Female Representation in the Workforce by Sector 

unit_check <- 1
unit_sdg   <- '%'
direction_sdg <- -1 ## func_norm_sdg_score_bad()

### Check the Unit!!!
### rel --> %
### ft  --> 10^3 ppl
### total workers --> 10^3 ppl


### Resource consumption or emissions under the current trading world situation --------------------
### use the row sum based on EORA data
f <- paste0(dir.eora_cleaned, ind_ft, '.xlsx')
rel <- readxl::read_excel(f) %>%
  ## for SHDB data, we use 2019 for 2015 because of data gap
  dplyr::mutate(year = ifelse(year == 2019, 2015, year)) %>%
  gather(key = 'd', value = 'value', 4:ncol(.)) %>%
  group_by(year, iso3, ctr) %>%
  dplyr::summarise(value = sum(value, na.rm = T)) %>%
  ## given most of the data in Greenland is missing, we set it as NA
  dplyr::mutate(value = ifelse(iso3 =='GRL', NA, value)) %>%
  dplyr::select(-ctr)


### Outsourced footprints (oft) flow -----------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  dplyr::mutate(net_in = ifelse(year == 2000, NA, net_in)) %>%  ## for SHDB data only, as no data for 2000
  spread(key = scenario, value = net_in) %>%
  arrange(ind, iso3, year)


### w/o trade, and with trade together  --------------------------------------------------
rel_not_merge <- rel %>%
  # merge(x = ., y = total_workers, by = c('iso3', 'year'), all.x = T) %>% ## data interpolation issue in this data
  merge(x = ., y = total_labor, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = ind_ft,
    ## total at-risk/total worker
    value_rel = (value)/(total_workers + 1),                          
    ## [(total at-risk) - (at-risk workers working for exports)] / total workers
    value_not = (value - (-fromAll)) / (total_workers),  
    ## [(total at-risk) - (at-risk workers working for nearby exports)] / total workers
    value_dst = (value - (-fromNer)) / (total_workers),
    value_ner = (value - (-fromDst)) / (total_workers)) %>% 
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())


rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


### ! Un-comment the following line to include this indicator in the final analysis 
score_5_5_2x <- df_score


### plot to compare ----------------------------------------------------------------------
helper_func_plot_map(data = rel_not, var = 'value_rel', yr = 2015, filename_postfix = paste0(ind_sdg, '_EORA'))
```


#### - 5.1 Gender Equality in workforce

  5.1 End all forms of discrimination against all women and girls everywhere
  
  - 5.1.1 Whether or not legal frameworks are in place to promote, enforce and monitor equality and non-discrimination on the basis of sex. 

  - For comparison, see Women's Workplace Equality Index <https://www.cfr.org/legal-barriers/country-rankings/>. See data and map in ".\Data\data_02_intermediate\dt01_ctr_profile\CFR Womens Workplace Equality Index Data.xlsx"
 
  The World Bank’s Women, Business and the Law 2018 report scored 189 countries on fifty gender inequalities in legal treatment. They grouped these into seven categories: accessing institutions, building credit, getting a job, going to court, protecting women from violence, providing incentives to work, and using property. CFR then ranked countries based on their overall average score, between 0 and 100 (100 being the best).


```{r}
ind_sdg <- 'Gender Equality in workforce'
ind_ft  <- 'SHDB15_3Be' 

## 3.B.e Overall Gender Inequity in Country

unit_check <- 1
unit_sdg   <- ""

direction_sdg <- -1

### Check the Unit!!!
### rel -->           10^3 person
### ft  -->           risk-weighted employment (Xiao et al. 2017, Ecological Economics)
### total workers --> 10^3 person


### Resource consumption or emissions under the current trading world situation ----------
### --> use the EORA data to calculate `total risk-weighted employment`
f <- paste0(dir.eora_cleaned, 'SHDB15_3Be.xlsx')
rel <- readxl::read_excel(f) %>%
  ### use SHDB 2019 for 2015 --------------------!!!
  dplyr::mutate(
    year = ifelse(year == 2019, 2015, year)) %>%
  gather(key = 'd', value = 'value', 4:ncol(.)) %>%
  group_by(year, iso3, ctr) %>%
  dplyr::summarise(value = sum(value, na.rm = F)) %>%
  # spread(key = 'year', value = 'sum') %>%
  # gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value),
                value = ifelse(value == 0, NA, value)) %>%
  dplyr::mutate(value = ifelse(iso3 == 'GRL', NA, value)) %>%   ## only for data from EORA - remove "Greenland"
  dplyr::select(-ctr) %>%
  arrange(iso3, year) %>%
  as.data.frame()


### Outsourced footprints (oft) flow -----------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  dplyr::mutate(net_in = ifelse(year == 2000, NA, net_in)) %>%  ## for SHDB data only, as no data for 2000
  spread(key = scenario, value = net_in) %>%
  arrange(ind, iso3, year)



### w/o trade, and with trade together  --------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = total_labor, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = ind_ft,
    ## total at-risk/total worker
    value_rel = (value)/(total_workers + 1),                          
    ## [(total at-risk) - (at-risk workers working for exports)] / total workers
    value_not = (value - (-fromAll)) / (total_workers),  
    ## [(total at-risk) - (at-risk workers working for nearby exports)] / total workers
    value_dst = (value - (-fromNer)) / (total_workers),
    value_ner = (value - (-fromDst)) / (total_workers)) %>% 
  dplyr::select(ind, iso3, year, value, everything())


# rel_not_merge1 <- 
  rel_not_merge %>%
  dplyr::select(iso3, starts_with('value_')) %>%
  gather(key = 'scenario', value = 'value', value_rel:value_ner) %>%
  ggplot(data = ., aes(x=scenario, y=value)) + 
  geom_violin(trim=FALSE)


check1 <- rel_not_merge %>% 
  dplyr::filter(year == 2015) %>%
  arrange(desc(value_rel)) %>%
  dplyr::mutate(rank=dense_rank(dplyr::desc(value_rel))) %>%
  as.data.frame()


rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

### ! Un-comment the following line to include this indicator in the final analysis 
score_5_1_1 <- df_score


### plot to compare ----------------------------------------------------------------------
helper_func_plot_map(data = rel_not, var = 'value_rel', yr = 2015, filename_postfix = ind_sdg)
```





### SDG 6 

  6.4.1 Change in water-use (WU) efficiency over time
```{r - 6.4.1 gdp/water}
ind_sdg    <- 'gdp_per_water' ## USD/m3
ind_ft     <- 'Water'
unit_check <- 10^9
direction_sdg <- 1

### Check the Unit!!!
### rel --> 10^9 m3
### oft --> m3
### gdp --> USD


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Total freshwater withdrawal', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = gdp_rel/(value +      0),
    value_not = gdp_not/(value + fromAll),
    value_dst = gdp_dst/(value + fromNer),
    value_ner = gdp_ner/(value + fromDst)
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_6_4_1 <- df_score
```






  6.4.2 Level of water stress: freshwater consumption as a proportion of available freshwater resources (WR)
```{r - 6.4.2 water/resources}
ind_sdg    <- 'water_stress' ## m3/m3
unit_check <- 10^9 
direction_sdg <- -1

### Check the Unit!!!
### rel --> 10^9 m3
### oft --> m3
### total  --> 10^9 m3


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Total freshwater withdrawal', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### freshwater resources
xls <- list.files(path = dir.input1, pattern = '^Renewable internal freshwater resources', full.names = T); xls 
total_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
total_water <- total_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'total_water', `2000`:ncol(.)) %>%
  dplyr::mutate(total_water = total_water*unit_check) %>%  
  as.data.frame()


### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'Water') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,          by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = total_water,  by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)/total_water,
    value_not = (value + fromAll)/total_water,
    value_dst = (value + fromNer)/total_water,
    value_ner = (value + fromDst)/total_water
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner) %>%
  
  ### ??? Can water intensity > 1?? --> YES! see data by World Bank https://data.worldbank.org/indicator/ER.H2O.FWST.ZS?locations=AE
  # mutate(value_rel = ifelse(value_rel > 1, NA, value_rel),
  #        value_not = ifelse(is.na(value_rel), NA, value_not)) %>%
  as.data.frame()

hist(rel_not$value_rel)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()



score_6_4_2 <- df_score
```




  6.3.2 Proportion of bodies of water with good ambient water quality
  
  Nitrogen footprint - nitrogen potentially exportable to water bodies	(NWP)
  
  - With-trade: total NWP footprint/water resources
  - No-trade:   (total NWP footprint + net imported NWP)/water resources
  
```{r - 6.3.2 NWP}
ind_sdg <- 'NWP concentration'
ind_ft  <- 'NitrogenNWP' 
unit_check <- 10^3
unit_ind   <- 'kg/m3'
direction_sdg <- -1

### Check the Unit!!!
### rel --> ton = 10^3 kg
### oft --> ton = 10^3 kg
### total water resources --> m3


### Resource consumption or emissions under the current trading world situation --------------------
getwd()
xls <- paste0(dir.input2, 'eora_cleaned/', ind_ft, ".xlsx"); xls
total_ft <- readxl::read_excel(path = xls) %>%
  # dplyr::filter(year == 2015) %>%
  as.data.frame() %>%
  dplyr::mutate(total_ft = rowSums(.[4:ncol(.)], na.rm = T)) %>%
  dplyr::select(iso3, year, total_ft)
  

### net imported footprints ------------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- total_ft %>%
  merge(x = ., y = total_water, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (total_ft +       0)*unit_check/total_water,
    value_not = (total_ft + fromAll)*unit_check/total_water,
    value_dst = (total_ft + fromNer)*unit_check/total_water,
    value_ner = (total_ft + fromDst)*unit_check/total_water
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, total_ft, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner) %>%
  
  ### ??? Can water intensity > 1??
  # dplyr::filter(value_rel <= 1) %>%
  # mutate(value_rel = ifelse(value_rel > 1, NA, value_rel),
  #        value_not = ifelse(is.na(value_rel), NA, value_not)) %>%
  as.data.frame()

hist(rel_not$value_rel, xlab = unit_ind)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_6_3_2 <- df_score
```



### SDG 7 

####  - 7.1.2 renewable/pop

  7.1.2 Proportion of population with primary reliance on clean fuels and technology [Metadata](https://unstats.un.org/sdgs/metadata/files/Metadata-07-01-02.pdf)

  
```{r}
ind_sdg    <- 'renewable_per_pop' ## TJ/pop
ind_ft     <- 'Energy_renewable'
unit_check <- 1
direction_sdg <- 1

### Check the Unit!!!
### rel    --> TJ;        
### oft    --> TJ
### pop    --> 1 

### PJ = 10^3 TJ
### TJ = 10^3 GJ 
#      = 10^6 MJ

### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Renewable energy consumption', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = ifelse(value == 0, NA, value)) %>%  ## 0 values cause large changes in the calculation 
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in) %>%       ## fix the unit issue, only for energy related indicators
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = ind_ft,
    value_rel = (value +       0)/pop,       
    value_not = (value + fromAll)/pop,
    value_dst = (value + fromNer)/pop,
    value_ner = (value + fromDst)/pop
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel, breaks = 100)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_7_1_2 <- df_score
```


####  - 7.3.1 total energy/gdp

  7.3.1 Energy intensity measured in terms of primary energy and GDP (low energy intensity indicates high SDG ind_sdg score)
  
  - **Energy intensity** is expressed in megajoules per unit of purchasing power parity GDP in constant 2017 USD figures. [SDG indicator metadata](https://unstats.un.org/sdgs/metadata/files/Metadata-07-03-01.pdf)

  - Also see "MJ per 2017 USD PPP" (https://www.iea.org/reports/sdg7-data-and-projections/energy-intensity)
  
  - *Primary energy*:  Energy in the form that it is first accounted for in a statistical energy balance, before any transformation to secondary or tertiary forms of energy. For example, coal can be converted to synthetic gas, which can be converted to electricity; in this example, coal is primary energy, synthetic gas is secondary energy, and electricity is tertiary energy. See Primary energy production and Primary energy consumption. [ref](https://www.eia.gov/tools/glossary/index.php?id=Primary%20energy)


  
```{r}
ind_sdg    <- 'energy_intensity' ## TJ/USD
ind_ft     <- 'Energytotal'
unit_check <- 1
direction_sdg <- -1

### Check the Unit!!!
### rel    --> TJ 
### oft    --> TJ     
### gdp    --> USD 

### PJ = 10^3 TJ
### TJ = 10^3 GJ 
### GJ = 10^6 MJ


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Total final energy consumption', full.names = T); xls 
xls <- list.files(path = dir.input1, pattern = '^Total Primary energy consumption_TJ', full.names = T); xls ## change on 8/18/2023
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in) %>%    ## fix the unit issue, only for energy related indicators
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in) %>%
  as.data.frame()
# unique(oft$scenario)


### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)/gdp_rel,
    value_not = (value + fromAll)/gdp_not,
    value_dst = (value + fromNer)/gdp_dst,
    value_ner = (value + fromDst)/gdp_ner
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_7_3_1 <- df_score





### for later use ---------------
totalenergy_rel_not <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind     = unique(oft$ind),
    var_rel = (value +       0),
    var_not = (value + fromAll),
    var_dst = (value + fromNer),
    var_ner = (value + fromDst)) %>%
  ### for easy-checking the numbers
  dplyr::select(iso3, year, var_rel, var_not, var_dst, var_ner) %>%
  dplyr::rename(
    EnergyTotal_rel = var_rel,
    EnergyTotal_not = var_not,
    EnergyTotal_dst = var_dst,
    EnergyTotal_ner = var_ner
  )
```


####  - 7.2.1 renewable/total

  7.2.1 Renewable energy share in the total final energy consumption
  
  [Metadata](https://unstats.un.org/sdgs/metadata/files/Metadata-07-02-01.pdf)
  
```{r}
ind_sdg    <- 'renewable_share' ## TJ/TJ
ind_ft     <- 'Energy_renewable'
unit_check <- ''
direction_sdg <- 1

### Check the Unit!!!
### rel    --> TJ
### oft    --> TJ; 
### total  --> TJ

### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Renewable energy consumption', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in) %>%       ## fix the unit issue, only for energy related indicators
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,                 by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = totalenergy_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = ind_ft,
    value_rel = (value +       0)/EnergyTotal_rel,
    value_not = (value + fromAll)/EnergyTotal_not,
    value_dst = (value + fromNer)/EnergyTotal_dst,
    value_ner = (value + fromDst)/EnergyTotal_ner
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)
hist(rel_not$value_rel)



### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_7_2_1 <- df_score
```



```{r --------- check - normalization, eval=FALSE, include=FALSE}
# Robust Scaling using scale()
library(scales)
# Robust Scaling for specific columns while ignoring NA values
# Custom Robust Scaling function with NA handling
robust_scale <- function(x) {
  median_val <- median(x, na.rm = TRUE)
  iqr_val <- IQR(x, na.rm = TRUE)
  scaled_val <- (x - median_val) / iqr_val
  scaled_val
}

# Apply the custom function to specific columns in the dataframe
# rel_not_scaled <- rel_not %>%
#   mutate_at(vars('value_rel', 'value_not', 'value_dst', 'value_ner'), 
#             ~ robust_scale(.))

df_score_scaled_robust <- df_score %>%
  mutate_at(vars('val'), 
            ~ robust_scale(.)) %>% 
  dplyr::filter(scenario == 'value_rel')

# Z-Score normalization for specific columns
df_score_scaled_z <- df_score %>%
  mutate_at(vars('val'), ~ scale(., center = TRUE, scale = TRUE)) %>% 
  dplyr::filter(scenario == 'value_rel')

df_score_rel <- df_score %>% 
  dplyr::filter(scenario == 'value_rel')

hist(rel_not$value_rel, breaks = 1000)
hist(rel_not_scaled$value_rel, breaks = 1000)
hist(df_score_rel$value_norm, breaks = 1000)
hist(df_score_scaled_robust$val, breaks = 1000)
hist(df_score_scaled_z$val, breaks = 1000)
```



```{r --------- check - change}
# df_score_chg <- df_score_scaled_robust %>%
# df_score_chg <- df_score_scaled_z %>%
df_score_chg <- df_score %>%
  dplyr::select(-val) %>%
  dplyr::rename(score = value_norm) %>%
  spread(key = scenario, value = score) %>%
  dplyr::mutate(
    value_chg = value_rel - value_not, 
    value_chg = ifelse(iso3 =='GRL', NA, value_chg)) %>%    ## Greenland
  dplyr::filter(year == 2015) %>%
  as.data.frame()


## merge the two data for plot
df_shp <- shp_ctr_list %>%
  merge(x = ., 
        y = df_score_chg, 
        by.x = 'iso_a3', by.y = 'iso3', all.x = T) %>%
  as.data.frame()


chg_err_group  <- df_shp %>% 
  dplyr::filter(year != 'na') %>%
  dplyr::mutate(goal = 7) %>%
  summarySE(measurevar= "value_chg", groupvars = c("year", 'group', "goal"), na.rm = T)

# str(chg_err_group)
levels(chg_err_group$group)
color_grp <- c('#F26463', '#2371A6') 

ggplot(data = chg_err_group, 
       aes(x = as.factor(goal),
           y = value_chg,
           fill = group)) +
  geom_bar(position = position_dodge(0.8), stat="identity", width = 0.8, show.legend = T)+
  geom_errorbar(aes(ymin=value_chg-se, ymax=value_chg+se), 
                width=.3, 
                position=position_dodge(.8)) +
  ylab("Impact on SDG score") + xlab('SDGs') + labs(fill = "Group")+
  # scale_fill_brewer(palette = "Blues", direction = -1) +
  scale_fill_manual(values = color_grp, guide = guide_legend(reverse = T)) +
  scale_y_continuous(n.breaks = 6) +
  coord_flip()+
  
  theme(
    legend.position = c(0.86, 0.16),    ## 0.15, 0.06
    # legend.key.size = unit(0.2,"cm"), 
    legend.box.background = element_rect(colour = "black"),
    legend.key.width  = unit(0.4,"cm"), 
    legend.key.height = unit(0.4,"cm"), 
    legend.text=element_text(size=rel(.9)),
    panel.grid.minor = element_blank())
```



### SDG 8 

#### - 8.1.1 gdp growth

  8.1 Sustain per capita economic growth in accordance with national circumstances and, in particular, at least 7 per cent gross domestic product growth per annum in the least developed countries.
  
  8.1.1 Annual growth rate of real GDP per capita

```{r }
ind_sdg  <- 'gdp_growth' ## usd/usd
unit_check <- 1 
direction_sdg <- 1

### Check the Unit!!!
### rel --> usd
### oft --> usd


### choose the base line year - 2000
base <- gdp_rel_not %>% 
  dplyr::filter(year == 2000) %>%
  dplyr::mutate(value = gdp_rel,
                `2000` = value, `2005` = `2000`, `2010` = `2000`, `2015` = `2000`) %>%
  dplyr::select(-gdp_rel, -gdp_not, -gdp_dst, -gdp_ner, -value) %>%
  gather(key = 'year', value = 'base', `2000`:ncol(.))
  

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- gdp_rel_not %>%
  merge(x = ., y = base,  by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (gdp_rel - base)/pop,
    value_not = (gdp_not - base)/pop,
    value_dst = (gdp_dst - base)/pop,
    value_ner = (gdp_ner - base)/pop
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)




### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_8_1_1 <- df_score
```



#### - 8.4.2x = 12.2.1x material/pop
   8.4.1 Material footprint, material footprint per capita, and material footprint per GDP
   8.4.2.1 Domestic material consumption per capita
  12.2.2.1
  
  Material Footprint (MF) is the attribution of global material extraction to domestic final demand of a country. 
  
  The total material footprint is the *sum* of the `material footprint` for *biomass, fossil fuels, metal ores and non-metallic minerals*. -- from https://unstats.un.org/sdgs/metadata/files/Metadata-12-02-01.pdf
  
***Note***
  DE    Domestic extraction
  MF    Material footprint            = DE + RMEIM - RMEEX
  DMC   Domestic material consumption = DE + IM - EX
  
  RMEIM Raw material equivalent of imports
  RMEEX Raw material equivalent of exports
  
  IM    Physical imports (direct, territorial)
  EX    Physical imports (direct, territorial)
  
  DMI   Direct material input = DE + IM
  PTB   Physical trade balance = IM - EX
  
Data Source: https://www.resourcepanel.org/global-material-flows-database

```{r}
ind_sdg  <- 'material_per_pop' ## ton/pop
ind_ft   <- 'Materialtotal'
unit_check <- 1
direction_sdg <- -1

### Check the Unit!!!
### rel --> ton
### ft  --> ton
### pop --> 1 people


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Domestic material extraction', full.names = T); xls 
mat_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
mat <- mat_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()



### resource footprint ----------------------------------------------------------------------------------
### - this is a ready-to-use data, instead of from EORA. 
### - There is no bi-lateral flows among countries in this data
# xls <- list.files(path = dir.input1, pattern = '^Material footprint', full.names = T); xls 
# ft_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
# ft   <- ft_w %>%
#   dplyr::select(-ctr) %>%
#   gather(key = 'year', value = 'ft', `2000`:ncol(.)) %>%
#   dplyr::mutate(ft = ft*unit_check) %>%  
#   dplyr::rename('MF' = 'ft') %>%
#   ## Since `MF = DE + RMEIM - RMEEX`, and we need the value of total net import, i.e., `fromAll` 
#   left_join(x=.,
#             y=mat %>% dplyr::rename('DE' = 'value'), 
#             by = c('iso3', 'year')) %>%
#   dplyr::mutate(fromAll = MF - DE,
#                 ind     = ind_ft) %>%
#   # dplyr::select(-MF, -DE) %>%
#   dplyr::select(ind, year, iso3, everything()) %>%
#   # dplyr::filter(year == 2015) %>%
#   as.data.frame()


### - UPDATE: bi-lateral material flow data were added on 8/17/2023
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)
  

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- mat %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    # ind       = 'material',
    value_rel = (value + 0)/pop,
    value_not = (value + fromAll)/pop,
    value_dst = (value + fromNer)/pop,
    value_ner = (value + fromDst)/pop,
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)



### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_8_4_2x <- df_score
```





####  - 8.4.2y = 12.2.1y material/gdp
   
   8.4.2-2 Domestic material consumption per GDP (low material intensity indicates high SDG ind_sdg score)
  12.2.2-2 
  
```{r include=FALSE}
ind_sdg  <- 'material_per_gdp' ## ton/usd
unit_check <- 1
direction_sdg <- -1

### Check the Unit!!!
### mat --> ton
### oft --> ton
### gdp --> USD


### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- mat %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    value_rel = (value +       0)/gdp_rel,
    value_not = (value + fromAll)/gdp_not,
    value_dst = (value + fromNer)/gdp_dst,
    value_ner = (value + fromDst)/gdp_ner,
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)



### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_8_4_2y <- df_score
```




#### - 8.8.1x fatal
  8.8.1 Fatal and non-fatal occupational injuries per 100,000 workers, by sex and migrant status
  - Fatal accidents footprints
  - non-fatal accidents footprints
  
```{r}
ind_sdg <- 'fatal_per_e5_workers'
ind_ft  <- 'osh_fatal' ## case
unit_check <- 1
unit_sdg   <- 'case/10^5 workers'
direction_sdg <- -1

### Check the Unit!!!
### rel --> 1
### ft  --> 1
### total workers --> 10^3


### Resource consumption or emissions under the current trading world situation --------------------
###  Cases of fatal occupational injury by economic activity | Annual, from 'ILOSTAT'
xls <- list.files(path = dir.input1, pattern = '^INJ_FATL_ECO_NB_A', full.names = T); xls
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value) %>%  
  as.data.frame()


### Total workers in a country
xls <- list.files(path = dir.input1, pattern = '^workers_thousands', full.names = T); xls 
total_workers <- readxl::read_excel(path = xls) %>% 
  as.data.frame() %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'total_workers', `2000`:ncol(.)) %>%
  dplyr::mutate(total_workers = as.numeric(total_workers),
                total_workers = total_workers*1000) %>%
  as.data.frame()

  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = total_workers, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)/total_workers*10^5,
    value_not = (value + fromAll)/total_workers*10^5,
    value_dst = (value + fromNer)/total_workers*10^5,
    value_ner = (value + fromDst)/total_workers*10^5
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_8_8_1x <- df_score
```



#### - 8.8.1y non-fatal 

  8.8.1 Non-fatal occupational injuries per 100,000 workers

```{r }
ind_sdg <- 'nonfatal_per_e5_workers'
ind_ft  <- 'osh_non-fatal' ## case
unit_check <- 1
unit_sdg   <- 'case/10^5 workers'
direction_sdg <- -1

### Check the Unit!!!
### rel --> 1
### ft  --> 1
### total workers --> 10^3


### Resource consumption or emissions under the current trading world situation --------------------
###  Cases of non-fatal occupational injury by economic activity | Annual, from 'ILOSTAT'
xls <- list.files(path = dir.input1, pattern = '^INJ_NFTL_ECO_NB_A', full.names = T); xls
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value) %>%  
  as.data.frame()


### Total workers in a country
### - see above chunk 
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = total_workers, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)/total_workers*10^5,
    value_not = (value + fromAll)/total_workers*10^5,
    value_dst = (value + fromNer)/total_workers*10^5,
    value_ner = (value + fromDst)/total_workers*10^5
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_8_8_1y <- df_score
```




### SDG 9 
  
#### - 9.4.1x CO2 emissions per unit of value added

```{r}
ind_sdg  <- 'co2_per_gdp' ## ton/USD
unit_check <- 1000
direction_sdg <- -1

### Check the Unit!!!
### rel --> kt = 1000 ton
### oft --> ton
### gdp --> USD


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^CO2', full.names = T); xls 

## real consumption/emission (unit = kt)
rel <- readxl::read_excel(path = xls) %>%  
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  ## kt = 1000 ton
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'CO2') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)/gdp_rel,
    value_not = (value + fromAll)/gdp_not,
    value_dst = (value + fromNer)/gdp_dst,
    value_ner = (value + fromDst)/gdp_ner
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_9_4_1x <- df_score



### for later use ---------------
co2_rel_not <- rel %>%
  merge(x = ., y = oft, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind     = unique(oft$ind),
    var_rel = (value +      0),
    var_not = (value + fromAll),
    var_dst = (value + fromNer),
    var_ner = (value + fromDst)
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(iso3, year, var_rel, var_not, var_dst, var_ner)
```




#### - ??? 9.4.1y CO2 emissions from fuel combustion
  
```{r}
# ind_sdg  <- 'co2_in_fossil' ## ton/ha

```



#### - 9.a.1 ODA to infrastructure

*SDG*
  9.a Facilitate sustainable and resilient infrastructure development in developing countries through enhanced financial, technological and technical support to African countries, least developed countries, landlocked developing countries and small island developing States 
  
  9.a.1 Total official international support (official development assistance plus other official flows) to infrastructure

*Flow*
  [x] AIDData, and Boston U's GDP center data, are both for China only (sending system). 
  
  [v] OECD - https://www.oecd.org/development/idsonline.htm 
  
    - “Flows by provider and recipient”, which provides comprehensive aggregate historical and forward-looking data on the volume, origin and destination of resource flows (including country programmable aid);
    
    - https://stats.oecd.org/Index.aspx?datasetcode=TABLE7B
    
    
  
```{r}
ind_sdg    <- 'ODA to infrastructure' ## USD
ind_ft     <- 'ODA_OOF_oecd_matrix'
unit_check <- ''
direction_sdg <- 1

### Check the Unit!!!
### rel -->
### oft --> USD
### gdp --> USD


### Resource consumption or emissions under the current trading world situation -------------------------
# rel <- 
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- oft %>%
  merge(x = ., y = gdp_rel_not,  by = c('iso3', 'year'), all.x = T) %>% 
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ##' if a country's net outflow < 0, we assume it does not have ODA to others, and assign 0 as its net outflow
    ##' outflow = (-fromAll) = value
    ##' add $1 to avoid zero values
    value     = (-fromAll),
    value_rel = ifelse( (-fromAll) > 0, (-fromAll), 0+1),  ##
    value_not = (0 + 1),              ## under no-trade 
    value_dst = ifelse( value-(-fromNer) >0, value-(-fromNer), 0+1), ## (total outflow) - (nearby outflow)
    value_ner = ifelse( value-(-fromDst) >0, value-(-fromDst), 0+1), ## (total outflow) - (distant outflow)
    
    # value_rel = value_rel/gdp_rel,      
    # value_not = value_not/gdp_not, 
    # value_dst = value_dst/gdp_dst,
    # value_ner = value_ner/gdp_ner
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())


rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_9_a_1 <- df_score
```



### SDG 10

  Goal 10. Reduce inequality within and among countries
  
  **10.4** Adopt policies, especially fiscal, wage and social protection policies, and progressively achieve greater equality

  **10.4.1** is the labour share of GDP, comprising wages and social protection transfers.
  
  
#### - 10.4.1 Labour share of GDP

  Labour share of Gross Domestic Product = Total compensation of employees / Gross Domestic Product * 100.
  
  It provides information about the relative share of output which is paid as compensation to employees (or *labor*) as compared with the share paid to *capital* in the production process for a given reference period. 
  
  "As mentioned above, this calculation method does not provide a comprehensive measure of the labour income share, as it does not take into account the *labour income* of the self-employed. Ideally, wherever possible, the numerator should be adjusted to include not only compensation of employees, but earnings of the self-employed as well."
  --> https://sdg-tracker.org/inequality
  
  (Alsamawi et al. 2014b) - The Employment Footprints of Nations
  
```{r}
ind_sdg <- 'labor salary OR income share of GDP'
ind_ft  <- 'Salary' ## wage footprint = labor salary = income footprint
unit_sdg   <- '%'
direction_sdg <- 1

### Check the Unit!!!
### rel --> % of GDP
### ft  --> 1000 USD
### GDP --> USD


### Resource consumption or emissions under the current trading world situation --------------------
###'  SDG_1041_NOC_RT_A -- SDG indicator 10.4.1 - Labour income share as a percent of GDP (%) 
###'  -- from ILO 
xls <- list.files(path = dir.input1, pattern = '^SDG_1041_NOC_RT_A', full.names = T); xls
rel <- readxl::read_excel(path = xls) %>%  
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value) %>%  
  as.data.frame()


### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in * 1000) %>% # unit: 1000 USD --> USD
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = 'scenario', value = 'net_in')


### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_lab = (value/100)*gdp_rel,                  ## labor income (USD)
    value_rel = (value_lab -          0)/gdp_rel*100, ## labor share of GDP (%)
    ## if no trade, for an exporter, less labor salary from exports (i.e., less `-fromAll`)
    value_not = (value_lab - (-fromAll))/gdp_not*100, 
    value_dst = (value_lab - (-fromNer))/gdp_dst*100,
    value_ner = (value_lab - (-fromDst))/gdp_ner*100
    ) %>%
  dplyr::select(-value_lab) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_10_4_1x <- df_score


### plot to compare ----------------------------------------------------------------------
helper_func_plot_map(data = rel_not, var = 'value_rel', yr = 2015, filename_postfix = ind_sdg)
helper_func_plot_map(data = rel_not, var = 'value_not', yr = 2015, filename_postfix = ind_sdg)
```


#### - 10.4.x Social protection

  *SDG* - 10.4 Adopt policies, especially fiscal, wage and social protection policies, and progressively achieve greater
equality
  
  *FT*  - 1.I Social Benefits - 1.I.n Overall risk of no or limited social benefits

```{r}
ind_sdg <- 'Risk of social benefits'
ind_ft  <- 'SHDB8_1In' 

direction_sdg <- -1

### Check the Unit!!!
### rel -->           10^3 person
### ft  -->           10^3 person
### total workers --> 10^3 person


### Resource consumption or emissions under the current trading world situation ----------
### --> use the EORA data to calculate `total risk-weighted employment`
f <- paste0(dir.eora_cleaned, ind_ft, '.xlsx')
rel <- readxl::read_excel(f) %>%
  ### use SHDB 2019 for 2015 --------------------!!!
  dplyr::mutate(
    year = ifelse(year == 2019, 2015, year)) %>%
  gather(key = 'to', value = 'value', 4:ncol(.)) %>%
  group_by(year, iso3, ctr) %>%
  dplyr::summarise(value = sum(value, na.rm = F)) %>%
  ungroup() %>%
  dplyr::mutate(value = as.numeric(value),
                value = ifelse(value == 0, NA, value)) %>%
  dplyr::mutate(value = ifelse(iso3 == 'GRL', NA, value)) %>%   ## only for data from EORA - remove "Greenland"
  dplyr::select(-ctr) %>%
  arrange(iso3, year) %>%
  as.data.frame()


### Outsourced footprints (oft) flow -----------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  dplyr::mutate(net_in = ifelse(year == 2000, NA, net_in)) %>%  ## for SHDB data only, as no data for 2000
  spread(key = scenario, value = net_in) %>%
  arrange(ind, iso3, year)



### w/o trade, and with trade together  --------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = total_labor, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = ind_ft,
    ## total at-risk/total worker
    value_rel = (value - 0)/(total_workers + 1),                          
    ## [(total at-risk) - (at-risk workers working for exports)] / total workers
    value_not = (value - (-fromAll)) / (total_workers),  
    ## [(total at-risk) - (at-risk workers working for nearby exports)] / total workers
    value_dst = (value - (-fromNer)) / (total_workers),
    value_ner = (value - (-fromDst)) / (total_workers)) %>% 
  dplyr::select(ind, iso3, year, value, everything())


# rel_not_merge1 <- 
  rel_not_merge %>%
  dplyr::select(iso3, starts_with('value_')) %>%
  gather(key = 'scenario', value = 'value', value_rel:value_ner) %>%
  ggplot(data = ., aes(x=scenario, y=value)) + 
  geom_violin(trim=FALSE)


check1 <- rel_not_merge %>% 
  dplyr::filter(year == 2015) %>%
  arrange(desc(value_rel)) %>%
  dplyr::mutate(rank=dense_rank(dplyr::desc(value_rel))) %>%
  as.data.frame()


rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  -------------------------------------------------------
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_10_4_x <- df_score
```




#### - 10.b.1x FDI for development

  10.b Encourage official development assistance and financial flows, including foreign direct investment,  to States where the need is greatest, in particular least developed countries, African countries, small island developing States and landlocked developing countries, in accordance with their national plans and programmes 
  
  10.b.1 Total resource flows for development, by recipient and donor countries and type of flow (e.g. official development assistance, foreign direct investment and other flows) 

```{r}

ind_sdg  <- 'FDI for development' ## 
ind_ft   <- 'FDI_matrix'

direction_sdg <- 1

### Check the Unit!!!
### rel --> USD
### oft --> USD
### gdp --> USD


### Outsourced footprints (oft) flow --------------------------------------------------------------------
#' net inflow of FDI
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  
  ## we need data -- net outflow, so 
  # dplyr::mutate(net_out = -net_in) %>%
  # dplyr::select(-net_in) %>%
  
  spread(key = scenario, value = net_in) %>%
  as.data.frame()
yrs <- unique(oft$year)



### Resource consumption or emissions under the current trading world situation -------------------------
#' we can use two data sources, one is the `Wold Bank` data, the other is `IMF`.
#' Here, we compared the two and decide to use `IMF` data because it offers bilateral flow data
#' 
#' 1. World Bank data 
#'    Total net inflows - here we need total net outflow, so here, we need to reverse the number
xls <- list.files(path = dir.input1, pattern = '^Foreign direct investment, net inflows', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(
    value = as.numeric(value),
    # value_abs = abs(value), ## since this indicator underline 'cooperation', the absolute value should be used.
    #
    ## choose the right value for next step
    value = -value            ## calculate net outflow
    ) %>%  
  dplyr::filter(year %in% yrs) %>%
  as.data.frame()



#' 2. IMF data
#'    The data can be derived from `FDI_matrix`
#' 
f <- paste0(dir.eora_cleaned, ind_ft, '.xlsx')
rel_outflow <- readxl::read_excel(f) %>%
  gather(key = 'receiving', value = value, 4:ncol(.)) %>%
  group_by(year, ctr, iso3) %>%
  dplyr::summarise_at(c("value"), sum, na.rm = TRUE) %>%
  ungroup() %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::select(-ctr) %>%
  as.data.frame()

rel_check <- merge(
  x = rel         %>% dplyr::rename('wb_outflow'  = 'value'),
  y = rel_outflow %>% dplyr::rename('fdi_outflow' = 'value'), 
  by = c('iso3', 'year')
)

rel_check %>%
  ggplot(aes(x = wb_outflow, y = fdi_outflow)) +
  geom_point() +
  geom_abline(slope = 1, color = 'red') +
  # scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
  #               labels = trans_format("log10", math_format(10^.x))) +
  # scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
  #               labels = trans_format("log10", math_format(10^.x))) +
  theme_bw()

#'
#' 3. also see comparison in `FDI_data_prep.Rmd` in "./Data/data_01_raw/FDI/"
#'    The two data are very different ... not sure why. But FDI's bilateral data
#'    make more sense. 
  

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel_outflow %>%
  merge(x = ., 
        y = oft,   
        by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    ## if a country's net outflow < 0, we assume it does not have FDI, and assign 0 as its net outflow
    value_rel = ifelse(value > 0, value, 0+1),  ##
    value_not = (0+1),                          ## under no-trade ## add $1 to avoid zero values
    value_dst = ifelse( (value-(-fromNer)) >0, (value-(-fromNer)), 0+1), ## (total outflow) - (nearby outflow)
    value_ner = ifelse( (value-(-fromDst)) >0, (value-(-fromDst)), 0+1), ## (total outflow) - (distant outflow)
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)

### 
rel_not_merge %>%
  ggplot(aes(x = value, y = -fromAll)) +
  geom_point() +
  geom_abline(slope = 1, color = 'red') +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  theme_bw()


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_10_b_1x <- df_score
```




### SDG 11

  11.6.2-1 Annual mean levels of fine particulate matter (e.g., PM2.5 and PM10) in cities (population weighted)
  
```{r - 11.6.21 pm25/pop}
ind_sdg  <- 'pm25_per_pop' ## ton/pop
unit_check <- 1000
direction_sdg <- -1

### Check the Unit!!!
### rel --> kt (EDGAR)    ## mg/m3 (world bank)
### ft  --> ton
### pop --> 1 people


### Resource consumption or emissions under the current trading world situation -------------------------
# xls <- list.files(path = dir.input1, pattern = '^PM2.5 air pollution', full.names = T); xls  ## data from world bank
xls <- list.files(path = dir.input1, pattern = '^PM25', full.names = T);                xls  ## data from EDGAR
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'PM25') %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)/pop,
    value_not = (value + fromAll)/pop, 
    value_dst = (value + fromNer)/pop,
    value_ner = (value + fromDst)/pop
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_11_6_2 <- df_score
```



  11.6.2-2 Annual mean levels of fine particulate matter (PM10) in cities (population weighted)
```{r - 11.6.22 pm10/pop}
ind_sdg  <- 'pm10_per_pop' ## ton/pop
unit_check <- 1000
direction_sdg <- -1

### Check the Unit!!!
### rel --> kt (EDGAR)    ## mg/m3 (world bank)
### ft  --> ton
### pop --> 1 people


### Resource consumption or emissions under the current trading world situation -------------------------
# xls <- list.files(path = dir.input1, pattern = '^PM2.5 air pollution', full.names = T); xls  ## data from world bank
xls <- list.files(path = dir.input1, pattern = '^PM10', full.names = T);                xls  ## data from EDGAR
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'PM10') %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0)/pop,
    value_not = (value + fromAll)/pop, 
    value_dst = (value + fromNer)/pop,
    value_ner = (value + fromDst)/pop
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_11_6_22 <- df_score
```




### SDG 12

#### - 12.2.1x = 8.4.2x Material footprint per capita

  **12.2.1** Material footprint, material footprint per capita, and material footprint per GDP

  - 12.2.1x Domestic material consumption per capita
  
```{r}
ind_sdg  <- 'Material footprint per capita' ## ton per capita
unit_check <- 1

### Check the Unit!!!
### rel --> ton   
### ft  --> ton
### pop --> 1 people


score_12_2_1x <- score_8_4_2x
```
  
  
  
#### - 12.2.1y = 8.4.2y Material footprint per GDP  
```{r}
ind_sdg  <- 'Material footprint per GDP' ## ton per USD
unit_check <- 1

### Check the Unit!!!
### rel         --> ton   
### ft          --> ton
### gdp_rel_not --> 1 $


score_12_2_1y <- score_8_4_2y
```




####  - 12.2.1 SO2
  **12.2.1** Material footprint, material footprint per capita, and material footprint per GDP
  - SO₂ emissions embodied in imports (kg/capita). SO₂ emissions have severe health impacts and are a significant cause of premature mortality worldwide.
  
```{r}
ind_sdg  <- 'so2_per_pop' ## kg per capita
ind_ft   <- 'SO2'
unit_check <- 1000
direction_sdg <- -1

### Check the Unit!!!
### rel --> kt (EDGAR)    
### ft  --> ton
### pop --> 1 people


### Resource consumption or emissions under the current trading world situation -------------------------
# xls <- list.files(path = dir.input1, pattern = '^PM2.5 air pollution', full.names = T); xls  ## data from world bank
xls <- list.files(path = dir.input1, pattern = '^SO2', full.names = T);                xls  ## data from EDGAR
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)*1000/pop, ## (ton of SO2)*1000 per capita = kg/person
    value_not = (value + fromAll)*1000/pop,
    value_dst = (value + fromNer)*1000/pop,
    value_ner = (value + fromDst)*1000/pop
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_12_2_1 <- df_score
```


#### - 12.2.1z NitrogenTotal/GDP -- using ag ❌,

  12.2.1 Material footprint per GDP - NitrogenTotal
  
  Emissions of reactive nitrogen embodied in imported goods and services. Reactive nitrogen corresponds here to emissions of *ammonia, nitrogen oxides and nitrous oxide* to the atmosphere, and of reactive nitrogen potentially exportable to water bodies, all of which can be harmful to human health and the environment.
  
  *Two data* can be used as the "Nitrogen Total" consumption
  
  * use ag nitrogen -> Nutrient nitrogen N (total)_Use per area of cropland (NOT used at the moment)
  
  * use the "Nitrogen Total" based on row sum of EORA matrix
  
```{r eval=FALSE, include=FALSE}

ind_sdg  <- 'NitrogenTotal per GDP' ## kg/$
ind_ft   <- 'NitrogenTotal'
unit_check <- 10^3
direction_sdg <- -1

### Check the Unit!!!
### rel            --> kg/ha 
### oft            --> ton => 10^3 kg
### cropland_area  --> ha


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Nutrient nitrogen N', full.names = T); xls
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value)) %>%  
  as.data.frame()


### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in * unit_check) %>%  
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = cropland_area, by = c('iso3', 'year'), all.x = T) %>%  
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = gdp_rel_not,   by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    N_used    = value*cropland_area,         ## kg/ha * ha
    value_rel = (N_used +       0)/gdp_rel,   
    value_not = (N_used + fromAll)/gdp_not,  ## if no trade, may need to use more N locally
    value_dst = (N_used + fromNer)/gdp_dst,
    value_ner = (N_used + fromDst)/gdp_ner
    ) %>%  ## kg/ha * ha / ha
  # dplyr::select(-N_used) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_12_2_1z <- df_score


### plot to compare ----------------------------------------------------------------------
# rel_not_sf  <- rel_not %>% 
#   dplyr::filter(year == 2015) %>%
#   merge(x = shp, y = ., by.x = "iso_a3", by.y = "iso3",  all.x = T)
# max <- max(rel_not_sf$value_rel, na.rm = T); max # 0.025
# min <- min(rel_not_sf$value_rel, na.rm = T); min # 0.000001094
# 
# p <- tm_shape(rel_not_sf) +
#   tm_fill('value_rel', style  = "quantile", n = 10, textNA = 'NA', colorNA = 'gray90') +
#   tm_borders(col = "grey", lwd = 0.1, lty = "solid", alpha = 0.99) +
#   tm_layout(frame = F, frame.lwd = 0.1,
#     legend.position = c(0,0),
#     legend.title.size = 0.9, legend.text.size  = 0.7,
#     legend.width = -0.5, legend.height = -0.5, outer.margins=0, inner.margins=0, 
#     panel.show = F)
# tmap_save(tm = p, filename = 'test1.jpg', width=7, height=2.8, units="in", dpi = 200)
```



####  - 12.2.1w NitrogenTotal/GDP - using EORA  
```{r}

ind_sdg  <- 'NitrogenTotal per GDP' ## kg/$
ind_ft   <- 'NitrogenTotal'
unit_check <- 1
direction_sdg <- -1

### Check the Unit!!!
### rel            --> ton
### oft            --> ton


### Resource consumption or emissions under the current trading world situation -------------------------

xls <- list.files(path = dir.input1, pattern = '^NitrogenTotal_ton', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value)) %>%  
  dplyr::mutate(value = ifelse(value == 0, NA, value)) %>%      ## only for data from EORA
  dplyr::mutate(value = ifelse(iso3 == 'SOM', NA, value)) %>%   ## only for data from EORA
  as.data.frame()

  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in * unit_check) %>%  
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = gdp_rel_not,   by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)/gdp_rel*1000,   
    value_not = (value + fromAll)/gdp_not*1000,  ## if no trade, may need to use more N locally
    value_dst = (value + fromNer)/gdp_dst*1000,
    value_ner = (value + fromDst)/gdp_ner*1000
    ) %>%  
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_12_2_1w <- df_score


### plot to compare ----------------------------------------------------------------------
# helper_func_plot_map(data = rel_not, var = 'value_rel', yr = 2015, filename_postfix = ind_sdg)
```





### SDG 13 

  13.2.2 Total greenhouse gas emissions per year
```{r - 13.2.2 total GHG}

ind_sdg    <- 'GHG emissions per year' ## ton/yr
ind_ft     <- 'GHG' ## ton
unit_check <- 1000
direction_sdg <- -1

### Check the Unit!!!
### rel --> kt = 1000 ton
### oft --> ton


### Resource consumption or emissions under the current trading world situation --------------------
xls   <- list.files(path = dir.input1, pattern = '^Total greenhouse gas emissions', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame() ## the status data 
### Consumption/emission (unit = kt) in real world
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  ## kt = 1000 ton
  as.data.frame()
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0),
    value_not = (value + fromAll),
    value_dst = (value + fromNer),
    value_ner = (value + fromDst)
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_13_2_2 <- df_score

```


  **13.2.s** CO2 emissions intensity of areas under forest management.
  
  - *???* need to further look into the calculation of this indicator, as the calculation is different from the Xu et al 2020 NS paper. 
  
```{r - 13.2.s co2/forest}
ind_sdg    <- 'CO2 per area of forest' ## ton/ha
ind_ft     <- 'Landuse_forest'         ## ha
unit_check <- 100 
direction_sdg <- -1

### Check the Unit!!!
### rel --> km2 = 100 ha (forest area data from world bank)
### oft --> ha           (embodied forest area from Eora)
### co2 --> ton


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Forest area', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%  # forest area in real world
  merge(x = ., y = oft,          by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = co2_rel_not,  by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = var_rel/(value - 0),   ## (co2 in real world) / (forest area in real world)
    # value_not = var_not/(value - net_in), ## (co2 if no trade)   / (forest area if no trade)
    value_not = var_not/(value - 0),   ## in 2020 NS paper, we use this calculation. (???), assuming forest don't change?
    value_dst = var_dst/(value - 0),
    value_ner = var_ner/(value - 0)
    ) %>%        
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)



### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_13_2_s <- df_score


### for later use ---------------
forest_rel_not <- rel %>%
  merge(x = ., y = oft, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind     = unique(oft$ind),
    var_rel = (value +      0),
    var_not = (value - fromAll), ## if no trade, a net importer would have less forest 
    var_dst = (value - fromNer),
    var_ner = (value - fromDst)
    ) %>% 
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, var_rel, var_not, var_dst, var_ner)
```




### SDG 14

#### - 14.1.1x Eutrophication - N

  **14.1.1** Index of coastal eutrophication
  
  Fertilizers Use per area of cropland (kg/ha), which can be a proxy of coastal *eutrophication*.
  
```{r}
ind_sdg  <- 'Eutrophication - N Use per area of cropland' ## kg/ha
ind_ft   <- 'NitrogenNWP'
direction_sdg <- -1

### Check the Unit!!!
### rel            --> kg/ha
### oft            --> ton = 1000 kg
### cropland_area  --> ha


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Nutrient nitrogen N', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value)) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in*1000) %>%  ## 1 ton = 1000 kg
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = cropland_area, by = c('iso3', 'year'), all.x = T) %>%  
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>% 
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    N_used    = value*cropland_area,
    value_rel = (value),                            ## kg/ha -- Nutrient nitrogen N (total)_Use per area of cropland_kg_ha
    value_not = (N_used + fromAll)/cropland_area,   ## if no trade, may need to use more N locally to produce food
    value_dst = (N_used + fromNer)/cropland_area,
    value_ner = (N_used + fromDst)/cropland_area
    ) %>%  ## kg/ha * ha / ha
  dplyr::select(-N_used) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_14_1_1x <- df_score
```


#### - 14.1.1y Eutrophication - P

  Fertilizers Use per area of cropland (kg/ha), which can be a proxy of coastal *eutrophication*.
  
```{r}
ind_sdg  <- 'Eutrophication - P Use per area of cropland' ## kg/ha
ind_ft   <- 'Phosphorusirriwater'
direction_sdg <- -1

### Check the Unit!!!
### rel            --> kg/ha
### oft            --> kton = 10^6 kg
### cropland_area  --> ha


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Nutrient phosphate P2O5', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value)) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in*10^6) %>%  ## 1 kton = 10^6 kg
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = cropland_area, by = c('iso3', 'year'), all.x = T) %>%  
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>% 
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    P_used    = value*cropland_area,
    value_rel = (P_used +       0)/cropland_area, ## kg/ha -- Nutrient phosphate P2O5 (total)_Use per area of cropland_kg_ha
    value_not = (P_used + fromAll)/cropland_area, ## kg/ha * ha / ha
    value_dst = (P_used + fromNer)/cropland_area,
    value_ner = (P_used + fromDst)/cropland_area
    ) %>%  
  dplyr::select(-P_used) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_14_1_1y <- df_score
```




#### - 14.4.1 Fisheries

  14.4.1 (Total fisheries production per capita) - Proportion of fish stocks within biologically sustainable levels
  
    * imported fisheries might cause overfishing in other regions
    
  
```{r}

ind_sdg  <- 'TradeMatrix_marine_capture_imported' ## ton/ton
ind_ft   <- 'TradeMatrix_marine_capture'
unit_check <- 1
direction_sdg <- -1

### Check the Unit!!!
### rel            --> ton
### oft            --> ton



### Resource consumption or emissions under the current trading world situation ----------
xls <- list.files(path = dir.input1, pattern = 'Fisheries production', recursive = T, full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value)) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow -----------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in * unit_check) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  --------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)/pop*10^3,  ## value = marine capture in tons --> kg per capita
    value_not = (value + fromAll)/pop*10^3,  ## 
    value_dst = (value + fromNer)/pop*10^3,
    value_ner = (value + fromDst)/pop*10^3
    ) %>%  
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -----------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_14_4_1 <- df_score
```



### SDG 15 

  15.1.1 Forest area as a proportion of total land area (high value indicates high SDG ind_sdg score)	
```{r - 15.1.1 forest/total land}
ind_sdg  <- 'forest_percent' ## m3/m3
unit_check <- 100 
direction_sdg <- 1

### Check the Unit!!!
### rel --> km2
### oft --> ha
### total  --> km2 m3


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area:  `land_total`; total land does not change
### --> forest footprint: `forest_rel_not`

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- 
  merge(x = land_total, y = forest_rel_not,  by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    value_rel = var_rel/(land_total_km2 * 100),      ## forest area/ total land area
    value_not = var_not/(land_total_km2 * 100),
    value_dst = var_dst/(land_total_km2 * 100),
    value_ner = var_ner/(land_total_km2 * 100)
    ) %>%  ## total land area does not change
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)




### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_15_1_1 <- df_score
```







  
  15.2.1 Progress towards sustainable forest management (forest area net change rate as a measure)	
  - forest change = (forest_t - forest_0)/forest_0
```{r - 15.2.1 forest change}
ind_sdg  <- 'forest_change' ## ha/ha
unit_check <- 100 
direction_sdg <- 1

### Check the Unit!!!
### rel --> km2  ## 1 km = 100 ha
### oft --> ha


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Forest area', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### choose the base line year - 2000
base <- rel %>% 
  dplyr::filter(year == 2000) %>%
  dplyr::mutate(`2000` = value, `2005` = `2000`, `2010` = `2000`, `2015` = `2000`) %>%
  dplyr::select(-year, -value) %>%
  gather(key = 'year', value = 'base', `2000`:ncol(.))
  

### or choose 1990 as the baseline year ------------------------------------------------------------
# xls <- list.files(path = dirname(dir.input1), pattern = '^Forest area', full.names = T); xls 
# base <- readxl::read_excel(path = xls) %>% 
#   as.data.frame() %>%
#   dplyr::select(iso3_eora, country_eora, `1990`)  %>%
#   dplyr::rename(iso3 = `iso3_eora`, ctr = `country_eora`) %>%
#   arrange(iso3) %>%
#   dplyr::mutate(`2000` = `1990`, `2005` = `1990`, `2010` = `1990`, `2015` = `1990`) %>%
#   dplyr::select(- `1990`, -ctr) %>%
#   gather(key = 'year', value = 'base', `2000`:ncol(.))  %>%
#   as.data.frame()


### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = base,           by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = forest_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (var_rel - base)/base,
    value_not = (var_not - base)/base,
    value_dst = (var_dst - base)/base,
    value_ner = (var_ner - base)/base
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)




### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_15_2_1 <- df_score
```


#### - 15.5.1 Biodiversity footprint 

**SDG**
  15.5 Take urgent and significant action to reduce the degradation of natural habitats, halt the loss of biodiversity and, by 2020, protect and prevent the extinction of threatened species

**Impact**
  - Potentially disappeared fraction of species (*PDF*) on annual crops
  
```{r}
ind_sdg    <- 'Biodiversity - PDF on annual crops' ## 
ind_ft     <- 'biodiversity_Annual crops' ## 
unit_check <- ''
direction_sdg <- -1

### Check the Unit!!!
### rel --> PDF
### oft --> PDF


### Resource consumption or emissions under the current trading world situation ----------
xls   <- paste0(dir.eora_cleaned, 'biodiversity_Annual crops.xlsx'); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame() ## the status data 
rel <- rel_w %>%
  gather(key = 'to', value = 'value', 4:ncol(.)) %>%
  dplyr::select(-ctr) %>%
  group_by(year, iso3) %>%
  dplyr::summarise_at(c("value"), sum, na.rm = TRUE) %>%
  ungroup() %>%
  # dplyr::filter(year %in% yrs) %>%
  as.data.frame()
# hist(rel$value)
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0),
    value_not = (value + fromAll), ## for a net importer, no trade means more PDF would occur in the country
    value_dst = (value + fromNer),
    value_ner = (value + fromDst)
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel, nclass = 100)
hist(rel_not$value_not, nclass = 100)

### normalization  -------------------------------------------------------
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

hist(df_score$value_norm, nclass = 100)

score_15_5_1 <- df_score


### plot to compare ----------------------------------------------------------------------
helper_func_plot_map(data = rel_not, var = 'value_rel', yr = 2015, filename_postfix = ind_sdg)
helper_func_plot_map(data = rel_not, var = 'value_not', yr = 2015, filename_postfix = ind_sdg)
```




### SDG 16


  16.2.2 Number of victims of human trafficking per 100,000 population, by sex, age and form of exploitation
  
  **NNED ATTENTION!!!**
    *0 is the best, large positive and negative are both bad*
    *Is there a need to divide population number?*
    
```{r - 16.2.2 human_trafficking}

ind_sdg    <- 'human_trafficking' ## person per 100,000 population
unit_check <- 1
direction_sdg <- -1

### Check the Unit!!!
### rel --> 
### oft --> person

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'human_trafficking') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- oft %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    victims   = 0 - fromAll,                      ## the number of victims of human trafficking that were 'exported' from this country
    value_rel = (victims)/pop*10^5,               ## victims per 100,000 population
    value_not = (victims - (-fromAll))/pop*10^5,  ## 0 transfer under no-trade
    value_dst = (victims - (-fromNer))/pop*10^5,
    value_ner = (victims - (-fromDst))/pop*10^5
    ) %>%   
  dplyr::select(-victims) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### normalization  --------------------------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_16_2_2 <- df_score
```




  16.4.2 Proportion of seized, found or surrendered arms whose illicit origin or context has been traced or established by a competent authority in line with international instruments
  - Exports of major conventional weapons (TIV constant million USD per 100,000 population)
 
 
  SIPRI has developed a unique system to measure the volume of international transfers of major conventional weapons using a common unit, the *trend-indicator value (TIV)*.
  The TIV is based on the known unit production costs of a core set of weapons and is intended *to represent the transfer of military resources* rather than the financial value of the transfer.
  
  **NNED ATTENTION!!!**
    *0 is the best, large positive and negative are both bad*
    *Is there a need to divide population number?*
 
```{r - 16.4.2 arms trade}
ind_sdg  <- 'arms_trade' ## TIV
ind_ft   <- 'arms_trade'
unit_check <- 1

### Check the Unit!!!
### rel --> 
### oft --> TIV



### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- oft %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    arms_sent = 0 - fromAll,
    value_rel = (arms_sent  + 0.1),        ## net exports as the measurement, add 0.1 to avoid 0 that may cause error in calculation
    value_not = (arms_sent - (-fromAll)),  ## 0 transfer under no-trade, add 0.1 to avoid 0 that may cause error in calculation
    value_dst = (arms_sent - (-fromNer)),
    value_ner = (arms_sent - (-fromDst))
  ) %>%
  dplyr::select(-arms_sent) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)




### normalization  --------------------------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_16_4_2 <- df_score
```




  16.5 Substantially reduce corruption and bribery in all their forms
  
```{r - 16.5 Corruption}

ind_sdg  <- 'Corruption' ## 
ind_ft   <- 'Corruption'
unit_check <- 1
direction_sdg <- -1

### Check the Unit!!!
### rel --> Point
### oft --> Point


xls <- list.files(path = dir.input1, pattern = '^Corruption_4yrs', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value)) %>%  
  dplyr::mutate(value = ifelse(value == 0, NA, value)) %>%      ## only for data from EORA
  # dplyr::mutate(value = ifelse(iso3 == 'SOM', NA, value)) %>%   ## only for data from EORA
  as.data.frame()



### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value)/pop,              ## for a exporter with corruption risk
    value_not = (value - (-fromAll))/pop, ## * for an exporter, if no trade, minus exported risk => less corruption impacts
    value_dst = (value - (-fromNer))/pop, ## * for an importer, if no trade, minus imported risk => reduce corruption impacts
    value_ner = (value - (-fromDst))/pop
  ) %>%
  dplyr::select(ind, iso3, year, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)


### --> to compare with Xiao et al 2017 paper "The Corruption Footprints of Nations"
check1 <- rel_not_merge %>% 
  dplyr::filter(year == 2010) %>%
  dplyr::mutate(importer_of_corruption = round(fromAll/pop/1000, digits = 4)) %>%
  arrange(desc(importer_of_corruption)) %>%
  dplyr::mutate(rank=dense_rank(desc(importer_of_corruption))) %>%
  as.data.frame()

# check2 <- rel_not_merge %>% 
#   dplyr::filter(year == 2010) %>% 
#   arrange(desc(value_rel)) %>% 
#   dplyr::mutate(rank=dense_rank(desc(value_rel)))


### normalization  -----------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_16_5 <- df_score




### plot to compare ----------------------------------------------------------------------
# helper_func_plot_map(data = rel_not, var = 'value_rel', yr = 2015, filename_postfix = ind_sdg)
```



#### - 16.a Peacekeeping??? ❓

```{r}

```





### SDG 17

#### - 17.3.1x FDI/GDP

  **17.3.1** Foreign direct investment as a proportion of gross national income (GNI)
  
  Based on description at [link](https://sdg-tracker.org/global-partnerships), foreign direct investment refers to direct investment equity flows in an economy. It is the sum of equity capital, reinvestment of earnings, and other capital. This series shows *net outflows of investment* from the reporting economy to the rest of the world, and is divided by GDP.
  
  *GNI* GNI (formerly GNP) is the sum of value added by all resident producers plus any product taxes (less subsidies) *not included* in the valuation of output plus net receipts of primary income (compensation of employees and property income) from abroad. Data are in current U.S. dollars. 

```{r}

ind_sdg  <- 'FDI per GDP' ## 
ind_ft   <- 'FDI_matrix'

direction_sdg <- 1

### Check the Unit!!!
### rel --> USD
### oft --> NA
### gdp --> USD

### Outsourced footprints (oft) flow --------------------------------------------------------------------
#' net inflow of FDI
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  
  ## we need data -- net outflow, so 
  # dplyr::mutate(net_out = -net_in) %>%
  # dplyr::select(-net_in) %>%
  
  spread(key = scenario, value = net_in) %>%
  as.data.frame()
yrs <- unique(oft$year)

### Resource consumption or emissions under the current trading world situation -------------------------
#' total net inflows
#' but we need total net outflow, so here, we need to reverse the number
xls <- list.files(path = dir.input1, pattern = '^Foreign direct investment, net inflows', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(
    value = as.numeric(value),
    # value_abs = abs(value), ## since this indicator underline 'cooperation', the absolute value should be used.
    #
    ## choose the right value for next step
    value = -value            ## calculate net outflow
    ) %>%  
  
  as.data.frame()
  

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = gdp_rel_not,  by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    
    ## if a country's net outflow < 0, we assume it does not have FDI, and assign 0 as its net outflow
    value_rel = ifelse(value > 0, value + 1, 0),  ##
    value_not = (value - value + 1),              ## under no-trade ## add $1 to avoid zero values
    value_dst = ifelse( (value-(-fromNer)) >0, (value-(-fromNer)), 0), ## (total outflow) - (nearby outflow)
    value_ner = ifelse( (value-(-fromDst)) >0, (value-(-fromDst)), 0), ## (total outflow) - (distant outflow)
    
    value_rel = value_rel/gdp_rel,      
    value_not = value_not/gdp_not, 
    value_dst = value_dst/gdp_dst,
    value_ner = value_ner/gdp_ner
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_17_3_1x <- df_score
```



#### - 17.3.1x FDI/GNI --- test

```{r}
ind_sdg  <- 'FDI per GNI' ## 
ind_ft   <- 'FDI_matrix'

direction_sdg <- 1


## load GNI data
gni_l <- gni %>% 
  gather(key = 'year', value = 'gni', 3:ncol(.))
yrs <- unique(oft$year)

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., 
        y = gni_l,   
        by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., 
        y = oft,   
        by = c('iso3', 'year'), all.x = T) %>%
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    
    ## if a country's net outflow < 0, we assume it does not have FDI, and assign 0 as its net outflow
    value_rel = ifelse(value > 0, value + 1, 0),  ##
    value_not = (value - value + 1),              ## under no-trade ## add $1 to avoid zero values
    value_dst = ifelse( (value-(-fromNer)) >0, (value-(-fromNer)), 0), ## (total outflow) - (nearby outflow)
    value_ner = ifelse( (value-(-fromDst)) >0, (value-(-fromDst)), 0), ## (total outflow) - (distant outflow)
    
    value_rel = value_rel/gni,      
    value_not = value_not/gni, 
    value_dst = value_dst/gni,
    value_ner = value_ner/gni
    ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -----------------------------------------------------------------------
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

check_GNI_17_3_1x <- df_score



### compare the result using GNI and GDP -------------------------------------------------
check_17 <- check_GNI_17_3_1x %>%
  merge(x = ., 
        y = score_17_3_1x, ## using GDP
        by = c("ind","iso3","year","scenario"))

check_17 %>%
  ggplot(aes(x = `val.x`, y = `val.y`)) +
  geom_point() +
  geom_abline(slope = 1) +
  # scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
  #               labels = trans_format("log10", math_format(10^.x))) +
  # scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
  #               labels = trans_format("log10", math_format(10^.x))) +
  xlab('using GNI') + ylab('using GDP') +
  theme_bw()
```



#### - 17.3.1y ODA/GDP

  *17.3.1* Official development assistance as a proportion of gross national income
  
  - Since this indicator underline 'cooperation', the *absolute value* should be used. 

```{r}
ind_sdg  <- 'ODA per GDP' ## 
# ind_ft     <- 'ODA_OOF_oecd_matrix'
direction_sdg <- 1

### Check the Unit!!!
### rel --> USD
### oft --> NA
### gdp --> USD


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Net ODA and official aid', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value     = as.numeric(value),
                value_abs = abs(value)) %>%  ## since this indicator underline 'cooperation', the absolute value should be used. 
  as.data.frame()
  

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = gdp_rel_not,  by = c('iso3', 'year'), all.x = T) %>% ## total land
  dplyr::filter(year %in% yrs) %>%
  dplyr::mutate(
    ind       = 'ODA',
    value_rel = (value_abs             + 1)/gdp_rel,      ## 
    value_not = (value_abs - value_abs + 1)/gdp_not,      ## under no-trade ## add $1 to avoid zero values
    value_dst = (NA)/gdp_dst,
    value_ner = (NA)/gdp_ner
  ) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_auto(
  df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95, direction = direction_sdg) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_17_3_1y <- df_score
```



### --------------
### All SDGs
### --------------

```{r}
dfs <- do.call(rbind, mget(ls(pattern="^score_"))) %>%
  dplyr::mutate(rowId = row.names(.),
                rowId = gsub('score\\_', '', rowId))  %>%
  separate(col = rowId, into = c('sdg_ind', 'num_id'), sep = '\\.', remove = T) %>%
  dplyr::select(-num_id) %>%
  separate(col = sdg_ind, into = c('goal', 'target', 'indicator'), sep = '\\_', remove = F) %>%
  dplyr::mutate(target = paste0(goal, '_', target)) %>%
  as.data.frame()

unique(dfs$sdg_ind) %>% sort()
unique(dfs$goal) %>% as.numeric() %>% sort()
skimr::skim(dfs)

f <- paste0('./Data/data_03_results/SDGs_all_', today, '.RData'); f
save(dfs, file = f)
```





