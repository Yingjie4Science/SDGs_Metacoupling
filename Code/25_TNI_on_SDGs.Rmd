---
title: "Spillover on SDGs"
author: "Yingjie Li"
date: "2021-03-01 (Updated: 2021-03-04)"
output: pdf_document
editor_options: 
  chunk_output_type: console
---


# Set up
```{r Dirs and packages}

### To clear your environment 
remove(list = ls())

### set work dir
path <- rstudioapi::getSourceEditorContext()$path
dir  <- dirname(rstudioapi::getSourceEditorContext()$path); dir
setwd(dir)
setwd('..') # set directory by one folder up
getwd()
dir.input1 <- './Data/data_02_intermediate/dt01_ctr_profile/xlsx/cleaned/'
dir.input2 <- './Data/data_02_intermediate/dt02_flows/eora_cleaned/'
dir.output <- './Data/data_03_results/'
dir.fig    <- './Data/Figure/'


### packages
source('./Code/_package list.R')

library(Rmisc) ## for `summarySE`
library(scales)
library(tmap)


### Disable Scientific Notation in R
options(scipen = 999) # Modify global options in R
```



```{r Theme and font}
theme_set(theme_bw())

### plot settings
unit_ns    <- 'cm'
width_1col <- 8.8   ## 1-column
width_2col <- 18    ## 2-column
font       <- 'sans'     ## "TT Arial"
font_size  <- 8          ##  Nature Sustainability: max = 7; min = 5
theme_ns <- 
  theme_bw()+
  theme(
    # axis.title =element_blank(),
    # axis.text  =element_blank(),
    # axis.ticks =element_blank(),
    # panel.background = element_rect(fill = NA),
    panel.grid.major.x = element_blank(),
    # panel.grid.major = element_blank(),
    # panel.grid.minor = element_line(colour = "red", size = 1),
    legend.background = element_rect(fill="transparent"),
    legend.key.size = unit(0.15,"cm"),
    text = element_text(size=font_size)
        )

theme_map <- theme(
    axis.title =element_blank(),
    axis.text  =element_blank(),
    axis.ticks =element_blank(),
    panel.background = element_rect(fill = NA),
    panel.grid  = element_blank())
```


```{r Functions}
### normalization using the function
### Rather than just dropping the top and bottom trim percent, these extreme values are replaced with values at the trim and 1- trim quantiles. See more at https://rdrr.io/cran/psych/man/winsor.html
### We added one more step of this data processing than Xu and Li et al 2020 in NS. 
source("./Code/function_norm_sdg_score_good_bad.R")

```


  The upper and lower bounds for normalization. 
  Here, we use the bounds by SDSN 2021. 
  
  *Note: * we do NOT use this, because there are few indicator overlap between this study and the SDSN reports. The data here might be useful for future rebuttal to reviewers. 

```{r Bounds}
getwd()
xls <- 'https://dashboards.sdgindex.org/static/downloads/files/SDR%202021%20-%20Database.xlsx'
xls <- 'G:/My Drive/_paper/SDGs/Refs/SDSN Reports/SDR2021/SDR 2021 - Database.xlsx'
b <- readxl::read_excel(path = xls, sheet = 'Codebook') %>%
  dplyr::select(IndCode, SDG, Global, Indicator, `Optimum (= 100)`, 
                `Lower Bound (=0)`, `Justification for Optimum`, Description) %>%
  dplyr::rename(Upper_100 = `Optimum (= 100)`, 
                Lower_0   = `Lower Bound (=0)`)

names(b)

writexl::write_xlsx(x = b, path = './Data/_SDG_ind_upper_lower_bounds.xlsx')

Note1 <- "please refer to `_SDG_ind_upper_lower_bounds_edited.xlsx` -- but still need to edit."
```



## Ancillary data

**FT data**
  Outsourced footprints embodied in net imports. 
  This data was generated by `22_10_TNI.Rmd` and `22_20_TNI_dst_ner.Rmd`. 

```{r FT data}

### load 1
ls_f <- list.files(path = dir.input2, pattern = '^net_imports_fromAll', full.names = T); ls_f
tail(ls_f, n = 1)
load(tail(ls_f, n = 1)) ## load the latest data


### load 2
ls_f <- list.files(path = dir.input2, pattern = '^net_imports_fromDst_fromNer', full.names = T); ls_f
tail(ls_f, n = 1)
load(tail(ls_f, n = 1)) 


### combine 
net_imports_bind <- rbind(net_imports_fromAll, net_imports_fromDst_fromNer) 
```


```{r Pop}
load('./Data/Ancillary_Data_ISO3code_shp.RData') ## iso_eora, pop, gdp (USD), shp, grp
pop_l <- pop %>% as.data.frame() %>%
  gather(key = 'year', value = 'pop', `2000`:ncol(.)) %>%
  dplyr::select(-ctr) %>%
  as.data.frame()

### extended country-iso3 pair list for matching
load('./Data/Ancillary_Data_iso_eora_ex.RData')  ## ## iso_eora_ex

### shp data for WIOD country list -------------------------------------------------------------
pattern <- paste0('shp_wiod.RData'); pattern
fname <- list.files(path = 'G:/My Drive/_paper/SDGs/SDGs_Global_Trade', recursive = T, full.names = T, pattern = pattern); fname
load(fname)
names(shp_wiod) <- c("ADM0_A3", "NAME", "iso_a3", "geometry")
```


```{r Land}
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Land area', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
land_total <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'land_total_km2', `2000`:ncol(.)) %>%
  as.data.frame()

ctr_eora_list <- land_total %>%
  distinct(iso3)
```


  GDP can be determined in three ways, all of which should, theoretically, give the same result. They are the production (or output or value added) approach, the income approach, or the speculated expenditure approach. It is representative of the total output and income within an economy
  
  In the *expenditure approach*, GDP (Y) is the sum of consumption (C), investment (I), government spending (G) and net exports (X – M), i.e., Y = C + I + G + (X − M). 
  
  Thus, if there were no trade, gdp* = gdp - net_exports = gdp + net_imports
```{r GDP}
ind_sdg    <- 'gdp' ## USD
ind_ft     <- 'GDP' 
unit_check <- 1

### Check the Unit!!!
### rel --> USD
### oft --> USD
### gdp --> USD

rel_w <- gdp ## the status data 

rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'gdp', `2000`:ncol(.)) %>%
  dplyr::mutate(gdp = gdp*unit_check) %>%
  as.data.frame()


### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind     = unique(oft$ind),
    gdp_rel = (gdp +      0),
    gdp_not = (gdp + fromAll),      ## if no       trade,                     gdp* = gdp + (net_imports from all countries)
    gdp_dst = (gdp + fromNer),      ## if only dst trade(i.e., no ner trade), gdp* = gdp + (net_imports from ner countries) 
    gdp_ner = (gdp + fromDst)) %>%  ## if only ner trade(i.e., no dst trade), gdp* = gdp + (net_imports from dst countries) 
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, gdp, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, gdp_rel, gdp_not, gdp_dst, gdp_ner)

gdp_rel_not <- rel_not %>%
  dplyr::select(-ind)
```




# ================================================================================================
#  Data 

##  SDG score and the Impacts

### SDG 1

  1.1.1 Proportion of the population living below the international poverty line
  
```{r - 1.1.1 Poverty population}
ind_sdg <- 'Poverty Proportion'
ind_ft  <- 'Poverty' 
unit_check <- 1
unit_ind   <- 'Percent'


### Check the Unit!!!
### rel         --> % of population
### oft         --> 1 people
### total pop_l --> 1 people


### Resource consumption or emissions under the current trading world situation --------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Poverty headcount', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = pop_l,  by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = oft,    by = c('iso3', 'year'), all.x = T) %>% 
  dplyr::mutate(
    ind       = unique(oft$ind),
    net_ex    = - fromAll,        ## number of employment at poverty associated with exports
    value_rel = (value + 0), 
    ## if no trade, an exporter would reduce the number of people at poverty (i.e., 'net_ex')
    value_not = (value/100*pop - net_ex)/(pop)*100,
    value_dst = (value/100*pop - (-fromNer))/(pop)*100,
    value_ner = (value/100*pop - (-fromDst))/(pop)*100
    ) %>%  
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_1_1_1 <- df_score

```



### SDG 2

  2.4.1 Proportion of agricultural area under productive and sustainable agriculture
```{r - 2.4.1 cropland/total land}
ind_sdg  <- 'cropland_percent' ## m2/m2
unit_check <- 1

### Check the Unit!!!
### rel --> ha
### oft --> ha
### total  --> km2


### Resource consumption or emissions under the current trading world situation --------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Arable land', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()


### --> cropland
xls <- list.files(path = dir.input1, pattern = '^Cropland_Area', full.names = T); xls 
cropland_area <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'cropland_area', `2000`:ncol(.)) %>%
  dplyr::mutate(cropland_area = cropland_area*1000) %>%   ## 1000 ha --> ha
  as.data.frame()
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'Landusecrop') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = land_total,  by = c('iso3', 'year'), all.x = T) %>% ## total land
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +       0)/(land_total_km2*100), ## 
    value_not = (value + fromAll)/(land_total_km2*100), ## cropland area under no-trade
    value_dst = (value + fromNer)/(land_total_km2*100),
    value_ner = (value + fromDst)/(land_total_km2*100)
    ) %>%  
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not, value_dst, value_ner)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_2_4_1 <- df_score


temp <- df_score %>% head(2) %>%
  dplyr::mutate(ind = 'test', year = 2015, val = 1, value_norm = 50)
temp[2,4] <- 'value_not'
```

  
  2.1.2 Prevalence of moderate or severe food insecurity in the population, based on the Food Insecurity Experience Scale (FIES)
```{r - 2.1.2 Cereals_ton}
ind_sdg <- 'Cereals_ton per person'
ind_ft  <- 'Cereals_net_Import' 
unit_check <- 1
unit_ind   <- 'kg per capita per year'

### Check the Unit!!!
### rel --> ton = 1000 kg
### oft --> 
### total pop --> 1


### Resource consumption or emissions under the current trading world situation --------------------
xls <- list.files(path = dir.input1, pattern = '^Cereals_Production', full.names = T); xls 
total_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
total_Cereals <- total_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'total_Cereals', `2000`:ncol(.)) %>%
  dplyr::mutate(total_Cereals = total_Cereals*1000) %>%  
  as.data.frame()
  

### net imported footprints ------------------------------------------------------------------------
xls1 <- list.files(path = dir.input1, pattern = '^Cereals_Import', full.names = T); xls1 
xls2 <- list.files(path = dir.input1, pattern = '^Cereals_Export', full.names = T); xls2 

import <- readxl::read_excel(xls1) %>% gather('year', 'import', 3:6)
export <- readxl::read_excel(xls2) %>% gather('year', 'export', 3:6)
oft    <- merge(import, export, by = c('iso3', 'ctr', 'year'), all = T) %>%
  dplyr::mutate(net_in = import - export,
                ind    = ind_ft)%>%
  dplyr::select(ind, year, iso3, net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- total_Cereals %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (total_Cereals + net_in)/pop,
    value_not = (total_Cereals +      0)/pop) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not) %>%
  as.data.frame()

hist(rel_not$value_rel, xlab = unit_ind)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_2_1_2 <- df_score
```

  

### SDG 3
  3.9.1 Mortality rate attributed to household and ambient air pollution ( --> ton of PM25 per km2)
```{r - 3.9.1 PM25/total land}
ind_sdg  <- 'PM25_concentration' ## ton/km2
unit_check <- 1000

### Check the Unit!!!
### rel --> kt = 1000 ton
### oft --> ton
### total  --> km2


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^PM25', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value),
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'PM25') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = land_total,  by = c('iso3', 'year'), all.x = T) %>% ## total land
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value + 0)/(land_total_km2*100),           ## 
    value_not = (value + net_in)/(land_total_km2*100)) %>%  ## cropland area under no-trade
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_3_9_1 <- df_score
```


  3.9.1 Mortality rate attributed to household and ambient air pollution ( --> ton of SO2 per km2)

```{r - 3.9.1s SO2/total land}
ind_sdg  <- 'SO2_concentration' ## ton/ha
unit_check <- 1000

### Check the Unit!!!
### rel --> kt = 1000 * ton
### oft --> ton
### total  --> km2 = 100 * ha


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^SO2', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value),
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'SO2') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>% 
  merge(x = ., y = land_total,  by = c('iso3', 'year'), all.x = T) %>% ## total land
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value + 0)/(land_total_km2*100),           ## 
    value_not = (value + net_in)/(land_total_km2*100)) %>%  ## cropland area under no-trade
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_3_9_1s <- df_score
```




  3.4.1 Mortality rate attributed to cardiovascular disease, cancer, diabetes or chronic respiratory disease
```{r - 3.4.1 Mortality NCD, eval=FALSE, include=FALSE}
ind_sdg    <- 'Mortality rate - NCD'
ind_ft     <- '' 
unit_check <- ''
unit_ind   <- 'death per million people'

### Check the Unit!!!
### rel       --> 1000 people
### oft       --> ?
### total pop --> 1 people


### Resource consumption or emissions under the current trading world situation --------------------
# xls <- list.files(path = dir.input1, pattern = '^Total NCD Deaths', full.names = T); xls
# rel <- readxl::read_excel(path = xls) %>% as.data.frame() %>%
#   dplyr::select(-ctr) %>%
#   gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
#   dplyr::mutate(value = value*1000) %>%
#   as.data.frame()
#   
# ### net imported footprints ------------------------------------------------------------------------
# oft    <- merge(import, export, by = c('iso3', 'ctr', 'year'), all = T) %>%
#   dplyr::mutate(ind = ind_ft)%>%
#   dplyr::select(ind, year, iso3, net_in)
# 
# 
# ### w/o trade, and with trade together  ------------------------------------------------------------
# rel_not_merge <- rel %>%
#   merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
#   merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
#   dplyr::mutate(
#     ind       = unique(oft$ind),
#     value_rel = (rel +      0)/pop,
#     value_not = (rel - net_in)/pop) %>% ## few imports, few death
#   dplyr::select(ind, iso3, year, net_in, everything())


xls <- list.files(path = dir.input1, pattern = '^death_NCDs', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% as.data.frame() 

rel_not_merge <- rel %>%
  dplyr::rename(iso3 = ISO3, net_in = death_NCD_imports) %>%
  merge(x = land_total %>%  distinct(iso3, year), y = ., by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = 'death_NCDs',
    value_rel = (death_NCD_total)/pop*10^6,
    value_not = (death_NCD_total - net_in)/pop*10^6) %>% ## few imports, few death
  dplyr::select(ind, iso3, year, net_in, everything())



rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not) %>%
  as.data.frame()

hist(rel_not$value_rel, xlab = unit_ind)

### test, if the calculation match Figure 3b in BMJ paper by Chung, Min et al 2021 -----------------
### --> yes!
rel_not_merge_shp <- rel_not_merge %>%
  merge(x = shp, y = ., by.x = "iso_a3", by.y = "iso3",  all.y = T) %>%
  dplyr::filter(year == 2015)

### any countries failed to be joined? --> ANT, SUN, SUN --> which are expected. 
rel_not_merge_shp_na <- rel_not_merge_shp %>%
  dplyr::filter(is.na(name))

ggplot(data = rel_not_merge_shp) +
  geom_sf(aes(fill = net_in/pop*10^6), size = 0.1) +
  scale_fill_viridis(direction = -1, 
                     name = 'net death_NCD_imports/pop\n*10^6',
                     na.value = "grey95", option = 'B') +
  theme_bw() +
  ggtitle('NCD death per million people due to red and processed meat trade in 2015') +
  theme_map
  
  

### normalization  ---------------------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_3_4_1 <- df_score
```





### SDG 4
  4.7.1 Extent to which (i) global citizenship education
  **NNED ATTENTION!!!**
    *which is good? net receiving or net sending? or both? and 0 is bad?* --> both.
    *Is there a need to divide population number?* --> yes. 
    
  (1) out-flow/pop: the more the better - engagement 
  (2)  in-flow/pop: the more the better - openness
  
  **comments**
  - to use total population or use `School enrollment, tertiary_population`
  
```{r - 4.7.1 student_flow}
ind_sdg  <- 'student_flow' ## person
unit_check <- 1

### Check the Unit!!!
### rel --> 
### oft --> person

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'student_flow') %>%
  dplyr::select(ind, year, iso3, total_ex, total_in)

length(unique(oft$iso3))

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- oft %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind      = unique(oft$ind),
    value_ex = total_ex/pop,  ## net exports as the measurement
    value_in = total_in/pop,
    value_rel= value_ex + value_in,
    value_not= 0) %>%         ## 0 transfer under no-trade
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value_rel, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  --------------------------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_4_7_1 <- df_score
```





### SDG 5

  5.5.2 Proportion of women in managerial positions
```{r - 5.5.2 Proportion of women in managerial positions}

ind_sdg <- 'Proportion of women in managerial positions'
ind_ft  <- 'SHDB15' ## Risk of Gender inequality by Sector based on representation in the workforce
unit_check <- 1
unit_sdg   <- '%'

### Check the Unit!!!
### rel --> %
### ft  --> 1 ppl
### total workers --> 10^3 ppl


### Resource consumption or emissions under the current trading world situation --------------------
###  Cases of fatal occupational injury by economic activity | Annual, from 'ILOSTAT'
xls <- list.files(path = dir.input1, pattern = '^Proportion of women in managerial', full.names = T); xls
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value) %>%  
  as.data.frame()


### Total workers in a country
xls <- list.files(path = dir.input1, pattern = '^workers_thousands', full.names = T); xls 
total_workers <- readxl::read_excel(path = xls) %>% 
  as.data.frame() %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'total_workers', `2000`:ncol(.)) %>%
  dplyr::mutate(total_workers = as.numeric(total_workers),
                total_workers = total_workers*1000) %>%
  as.data.frame()

  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = total_workers, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0), ## % of female
    ## 'net_in' is the risk of non-female, which can be seen as "the number of male" - the higher the worse
    male_rel = (1-value/100)*total_workers, 
    ## for an exporter, the risk of this indicator = being a male; if no trade, then less risk
    net_exp  = - net_in,
    ## to calculate the number of male if no trade
    male_not = male_rel - net_exp, ## if no trade, then less risk
    ## to calculate the number of female under no-trade assumption
    value_not = (total_workers - male_not)/total_workers*100) %>% ## net_in is a risk
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_5_5_2 <- df_score
```






### SDG 6 

  6.4.1 Change in water-use (WU) efficiency over time
```{r - 6.4.1 gdp/water}
ind_sdg    <- 'gdp_per_water' ## USD/m3
unit_check <- 10^9

### Check the Unit!!!
### rel --> 10^9 m3
### oft --> m3
### gdp --> USD


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Total freshwater withdrawal', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'Water') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = gdp_rel/(value +      0),
    value_not = gdp_not/(value + net_in)) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_6_4_1 <- df_score
```






  6.4.2 Level of water stress: freshwater consumption as a proportion of available freshwater resources (WR)
```{r - 6.4.2 water/resources}
ind_sdg    <- 'water_stress' ## m3/m3
unit_check <- 10^9 

### Check the Unit!!!
### rel --> 10^9 m3
### oft --> m3
### total  --> 10^9 m3


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Total freshwater withdrawal', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### freshwater resources
xls <- list.files(path = dir.input1, pattern = '^Renewable internal freshwater resources', full.names = T); xls 
total_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
total_water <- total_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'total_water', `2000`:ncol(.)) %>%
  dplyr::mutate(total_water = total_water*unit_check) %>%  
  as.data.frame()


### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'Water') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,          by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = total_water,  by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0)/total_water,
    value_not = (value + net_in)/total_water) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not) %>%
  
  ### ??? Can water intensity > 1??
  # dplyr::filter(value_rel <= 1) %>%
  mutate(value_rel = ifelse(value_rel > 1, NA, value_rel),
         value_not = ifelse(is.na(value_rel), NA, value_not)) %>%
  as.data.frame()

hist(rel_not$value_rel)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()



score_6_4_2 <- df_score
```




  6.3.2 Proportion of bodies of water with good ambient water quality
  
  Nitrogen footprint - nitrogen potentially exportable to water bodies	(NWP)
  
  - With-trade: total NWP footprint/water resources
  - No-trade:   (total NWP footprint + net imported NWP)/water resources
  
```{r - 6.3.2 NWP}
ind_sdg <- 'NWP concentration'
ind_ft  <- 'NitrogenNWP' 
unit_check <- 10^3
unit_ind   <- 'kg/m3'

### Check the Unit!!!
### rel --> ton = 10^3 kg
### oft --> ton = 10^3 kg
### total water resources --> m3


### Resource consumption or emissions under the current trading world situation --------------------
getwd()
xls <- paste0(dir.input2, ind_ft, ".xlsx"); xls
total_ft <- readxl::read_excel(path = xls) %>%
  # dplyr::filter(year == 2015) %>%
  as.data.frame() %>%
  dplyr::mutate(total_ft = rowSums(.[4:ncol(.)], na.rm = T)) %>%
  dplyr::select(iso3, year, total_ft)
  

### net imported footprints ------------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- total_ft %>%
  merge(x = ., y = total_water, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (total_ft +      0)*unit_check/total_water,
    value_not = (total_ft + net_in)*unit_check/total_water) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, total_ft, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not) %>%
  
  ### ??? Can water intensity > 1??
  # dplyr::filter(value_rel <= 1) %>%
  mutate(value_rel = ifelse(value_rel > 1, NA, value_rel),
         value_not = ifelse(is.na(value_rel), NA, value_not)) %>%
  as.data.frame()

hist(rel_not$value_rel, xlab = unit_ind)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_6_3_2 <- df_score
```



### SDG 7 

  7.1.2 Proportion of population with primary reliance on clean fuels and technology
```{r - 7.1.2 renewable/pop}
ind_sdg  <- 'renewable_per_pop' ## TJ/pop
unit_check <- 1
### Check the Unit!!!
### rel    --> TJ;        
### oft    --> TJ*1000; 
### pop    --> 1 

### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Renewable energy consumption', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'Energy_renewable') %>%
  dplyr::mutate(net_in = net_in/10^3) %>%       ## fix the unit issue, only for energy related indicators
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0)/pop,       
    value_not = (value + net_in)/pop) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_7_1_2 <- df_score
```


  7.3.1 Energy intensity measured in terms of primary energy and GDP (low energy intensity indicates high SDG ind_sdg score)
```{r - 7.3.1 total energy/gdp}
ind_sdg  <- 'energy_intensity' ## TJ/USD
unit_check <- 1
### Check the Unit!!!
### rel    --> TJ; 
### oft    --> TJ*1000;   ## 1 PJ = 1000 TJ
### gdp    --> USD 

### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Total final energy consumption', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'Energytotal') %>%
  dplyr::mutate(net_in = net_in/10^3) %>%    ## fix the unit issue, only for energy related indicators
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0)/gdp_rel,
    value_not = (value + net_in)/gdp_not) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()



### for later use ---------------
totalenergy_rel_not <- rel %>%
  merge(x = ., y = oft, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind     = unique(oft$ind),
    var_rel = (value +      0),
    var_not = (value + net_in)) %>%
  ### for easy-checking the numbers
  dplyr::select(iso3, year, var_rel, var_not)

score_7_3_1 <- df_score
```

  7.2.1 Renewable energy share in the total final energy consumption
```{r - 7.2.1 renewable/total}
ind_sdg  <- 'renewable_share' ## TJ/TJ
unit_check <- 1
### Check the Unit!!!
### rel    --> TJ;        
### oft    --> TJ*1000; 
### total  --> TJ 

### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Renewable energy consumption', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'Energy_renewable') %>%
  dplyr::mutate(net_in = net_in/10^3) %>%       ## fix the unit issue, only for energy related indicators
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,                 by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = totalenergy_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0)/var_rel,       ## var_rel --> total energy use under real world
    value_not = (value + net_in)/var_not) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)
hist(rel_not$value_rel)



### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_7_2_1 <- df_score
```






### SDG 8 

#### - 8.1.1 gdp growth

  8.1 Sustain per capita economic growth in accordance with national circumstances and, in particular, at least 7 per cent gross domestic product growth per annum in the least developed countries.
  
  8.1.1 Annual growth rate of real GDP per capita

```{r }
ind_sdg  <- 'gdp_growth' ## usd/usd
unit_check <- 1 

### Check the Unit!!!
### rel --> usd
### oft --> usd


### choose the base line year - 2000
base <- gdp_rel_not %>% 
  dplyr::filter(year == 2000) %>%
  dplyr::mutate(value = gdp_rel,
                `2000` = value, `2005` = `2000`, `2010` = `2000`, `2015` = `2000`) %>%
  dplyr::select(-gdp_rel, -gdp_not, -value) %>%
  gather(key = 'year', value = 'base', `2000`:ncol(.))
  

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- gdp_rel_not %>%
  merge(x = ., y = base,  by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (gdp_rel - base)/pop,
    value_not = (gdp_not - base)/pop) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)




### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_8_1_1 <- df_score
```



*#### - 8.4.21 material/pop?
   8.4.2-1 Domestic material consumption per capita
  12.2.2-1
  
***Note***
  DE    Domestic extraction
  MF    Material footprint            = DE + RMEIM - RMEEX
  DMC   Domestic material consumption = DE + IM - EX
  
  RMEIM Raw material equivalent of imports
  RMEEX Raw material equivalent of exports
  
  IM    Physical imports (direct, territorial)
  EX    Physical imports (direct, territorial)
  
  DMI   Direct material input = DE + IM
  PTB   Physical trade balance = IM - EX
  
Data Source: https://www.resourcepanel.org/global-material-flows-database

```{r }
ind_sdg  <- 'material_per_pop' ## ton/pop
unit_check <- 1

### Check the Unit!!!
### rel --> ton
### ft  --> ton
### pop --> 1 people


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^DE tonnes', full.names = T); xls 
mat_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
mat <- mat_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()



### resource footprint ----------------------------------------------------------------------------------
### - this is a ready-to-use data, instead of from EORA. 
### - There is no bi-lateral flows among countries in this data
xls <- list.files(path = dir.input1, pattern = '^MF tonnes', full.names = T); xls 
ft_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
ft   <- ft_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'ft', `2000`:ncol(.)) %>%
  dplyr::mutate(ft = ft*unit_check) %>%  
  as.data.frame()



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- mat %>%
  merge(x = ., y = ft,    by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = 'material',
    value_rel = (value + 0)/pop,
    value_not = (ft       )/pop) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, ft, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)



### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

```





####  - 8.4.22 material/gdp?

   8.4.2-2 Domestic material consumption per GDP (low material intensity indicates high SDG ind_sdg score)
  12.2.2-2 
```{r}
ind_sdg  <- 'material_per_gdp' ## ton/usd
unit_check <- 1

### Check the Unit!!!
### mat --> ton
### oft --> ton
### gdp --> USD


### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- mat %>%
  merge(x = ., y = ft,          by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = 'material',
    value_rel = (value + 0)/gdp_rel,
    value_not = (ft       )/gdp_not) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, ft, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)



### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

```




#### - 8.8.1x fatal
  8.8.1 Fatal and non-fatal occupational injuries per 100,000 workers, by sex and migrant status
  - Fatal accidents footprints
  - non-fatal accidents footprints
  
```{r}
ind_sdg <- 'fatal_per_e5_workers'
ind_ft  <- 'osh_fatal' ## case
unit_check <- 1
unit_sdg   <- 'case/10^5 workers'

### Check the Unit!!!
### rel --> 1
### ft  --> 1
### total workers --> 10^3


### Resource consumption or emissions under the current trading world situation --------------------
###  Cases of fatal occupational injury by economic activity | Annual, from 'ILOSTAT'
xls <- list.files(path = dir.input1, pattern = '^INJ_FATL_ECO_NB_A', full.names = T); xls
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value) %>%  
  as.data.frame()


### Total workers in a country
xls <- list.files(path = dir.input1, pattern = '^workers_thousands', full.names = T); xls 
total_workers <- readxl::read_excel(path = xls) %>% 
  as.data.frame() %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'total_workers', `2000`:ncol(.)) %>%
  dplyr::mutate(total_workers = as.numeric(total_workers),
                total_workers = total_workers*1000) %>%
  as.data.frame()

  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = total_workers, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0)/total_workers*10^5,
    value_not = (value + net_in)/total_workers*10^5) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_8_8_1x <- df_score
```



#### - 8.8.1y non-fatal 

  8.8.1 Non-fatal occupational injuries per 100,000 workers

```{r }
ind_sdg <- 'nonfatal_per_e5_workers'
ind_ft  <- 'osh_non-fatal' ## case
unit_check <- 1
unit_sdg   <- 'case/10^5 workers'

### Check the Unit!!!
### rel --> 1
### ft  --> 1
### total workers --> 10^3


### Resource consumption or emissions under the current trading world situation --------------------
###  Cases of non-fatal occupational injury by economic activity | Annual, from 'ILOSTAT'
xls <- list.files(path = dir.input1, pattern = '^INJ_NFTL_ECO_NB_A', full.names = T); xls
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value) %>%  
  as.data.frame()


### Total workers in a country
### - see above chunk 
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = total_workers, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0)/total_workers*10^5,
    value_not = (value + net_in)/total_workers*10^5) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_8_8_1y <- df_score
```




### SDG 9 
  9.4.1-1 CO2 emissions per unit of value added

```{r - 9.4.1x co2/gdp}
ind_sdg  <- 'co2_per_gdp' ## ton/USD
unit_check <- 1000

### Check the Unit!!!
### rel --> kt = 1000 ton
### oft --> ton
### gdp --> USD


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^CO2', full.names = T); xls 

## real consumption/emission (unit = kt)
rel <- readxl::read_excel(path = xls) %>%  
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  ## kt = 1000 ton
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'CO2') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0)/gdp_rel,
    value_not = (value + net_in)/gdp_not) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_9_4_1x <- df_score



### for later use ---------------
co2_rel_not <- rel %>%
  merge(x = ., y = oft, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind     = unique(oft$ind),
    var_rel = (value +      0),
    var_not = (value + net_in)) %>%
  ### for easy-checking the numbers
  dplyr::select(iso3, year, var_rel, var_not)
```





  9.4.1-2 CO2 emissions from fuel combustion
```{r - 9.4.1y co2 in fossil ?}
ind_sdg  <- 'co2_in_fossil' ## ton/ha


```




### SDG 10

  **10.4.1** is the labour share of GDP, comprising wages and social protection transfers.
  
  Labour share of Gross Domestic Product = Total compensation of employees / Gross Domestic Product * 100.
  
  It provides information about the relative share of output which is paid as compensation to employees (or *labour*) as compared with the share paid to *capital* in the production process for a given reference period. 
  
  "As mentioned above, this calculation method does not provide a comprehensive measure of the labour income share, as it does not take into account the *labour income* of the self-employed. Ideally, wherever possible, the numerator should be adjusted to include not only compensation of employees, but earnings of the self-employed as well."
  --> https://sdg-tracker.org/inequality
  
  (Alsamawi et al. 2014b) - The Employment Footprints of Nations
  
```{r - 10.4.1 Labour share of GDP}
ind_sdg <- 'labor salary OR income share of GDP'
ind_ft  <- 'Salary' ## wage footprint = labor salary/income footprint
unit_sdg   <- '%'

### Check the Unit!!!
### rel --> % of GDP
### ft  --> 1000 USD
### GDP --> ?


### Resource consumption or emissions under the current trading world situation --------------------
###  SDG_1041_NOC_RT_A -- SDG indicator 10.4.1 - Labour income share as a percent of GDP (%) -- from ILO 
xls <- list.files(path = dir.input1, pattern = '^SDG_1041_NOC_RT_A', full.names = T); xls
rel <- readxl::read_excel(path = xls) %>%  
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value) %>%  
  as.data.frame()


### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in * 1000) %>% # unit: 1000 USD 
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = oft,         by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0), # the unit of `value` is %
    value_not = (value/100*gdp_rel + net_in)/gdp_not*100) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_10_4_1 <- df_score
```






### SDG 11

  11.6.2-1 Annual mean levels of fine particulate matter (e.g., PM2.5 and PM10) in cities (population weighted)
```{r - 11.6.21 pm25/pop}
ind_sdg  <- 'pm25_per_pop' ## ton/pop
unit_check <- 1000

### Check the Unit!!!
### rel --> kt (EDGAR)    ## mg/m3 (world bank)
### ft  --> ton
### pop --> 1 people


### Resource consumption or emissions under the current trading world situation -------------------------
# xls <- list.files(path = dir.input1, pattern = '^PM2.5 air pollution', full.names = T); xls  ## data from world bank
xls <- list.files(path = dir.input1, pattern = '^PM25', full.names = T);                xls  ## data from EDGAR
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'PM25') %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0)/pop,
    value_not = (value + net_in)/pop) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_11_6_2 <- df_score
```



  11.6.2-2 Annual mean levels of fine particulate matter (PM10) in cities (population weighted)
```{r - 11.6.22 pm10/pop}
ind_sdg  <- 'pm10_per_pop' ## ton/pop
unit_check <- 1000

### Check the Unit!!!
### rel --> kt (EDGAR)    ## mg/m3 (world bank)
### ft  --> ton
### pop --> 1 people


### Resource consumption or emissions under the current trading world situation -------------------------
# xls <- list.files(path = dir.input1, pattern = '^PM2.5 air pollution', full.names = T); xls  ## data from world bank
xls <- list.files(path = dir.input1, pattern = '^PM10', full.names = T);                xls  ## data from EDGAR
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'PM10') %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0)/pop,
    value_not = (value + net_in)/pop) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_11_6_22 <- df_score
```




### SDG 12
  **12.2.1** Material footprint, material footprint per capita, and material footprint per GDP

  - 12.2.1x Domestic material consumption per capita
  
```{r - 12.2.1x Material footprint per capita}
ind_sdg  <- 'Material footprint per capita' ## ton per capita
unit_check <- 1

### Check the Unit!!!
### rel --> ton   
### ft  --> ton
### pop --> 1 people


### Resource consumption or emissions under the current trading world situation -------------------------
## DE    Domestic extraction (unit: tonne)
xls <- list.files(path = dir.input1, pattern = '^Domestic material extraction', full.names = T); xls
DE <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
## --> Material footprint (mft) = DE + RMEIM - RMEEX
xls <- list.files(path = dir.input1, pattern = '^Material footprint', full.names = T); xls
mft <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                ind   = 'Material footprint') %>% 
  dplyr::rename(mft = value) %>%
  dplyr::select(ind, year, iso3, mft) %>%
  as.data.frame()


### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- DE %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = mft,   by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    value_rel = (value)/pop,
    value_not = (mft  )/pop) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_12_2_1x <- df_score
```
  
  
  
  
```{r - 12.2.1y Material footprint per GDP}
ind_sdg  <- 'Material footprint per GDP' ## ton per USD
unit_check <- 1

### Check the Unit!!!
### rel         --> ton   
### ft          --> ton
### gdp_rel_not --> 1 $



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- DE %>%
  merge(x = ., y = gdp_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = mft,         by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    value_rel = (value)/gdp_rel,
    value_not = (mft  )/gdp_not) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_12_2_1y <- df_score
```





  **12.2.1** Material footprint, material footprint per capita, and material footprint per GDP
  - SO₂ emissions embodied in imports (kg/capita). SO₂ emissions have severe health impacts and are a significant cause of premature mortality worldwide.
  
```{r - 12.2.1 SO2}
ind_sdg  <- 'so2_per_pop' ## ton/pop
unit_check <- 1000

### Check the Unit!!!
### rel --> kt (EDGAR)    
### ft  --> ton
### pop --> 1 people


### Resource consumption or emissions under the current trading world situation -------------------------
# xls <- list.files(path = dir.input1, pattern = '^PM2.5 air pollution', full.names = T); xls  ## data from world bank
xls <- list.files(path = dir.input1, pattern = '^SO2', full.names = T);                xls  ## data from EDGAR
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value), 
                value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'SO2') %>%
  # dplyr::mutate(net_in = format(net_in, scientific = F)) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft,   by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_in  = net_in*1000/pop,
    value_rel = (value +      0)*1000/pop,
    value_not = (value + net_in)*1000/pop) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_12_2_1 <- df_score
```



  12.2.1 Material footprint per GDP - NitrogenTotal
```{r - 12.2.1z NitrogenTotal/GDP ?}

```




### SDG 13 

  13.2.2 Total greenhouse gas emissions per year
```{r - 13.2.2 total GHG}

ind_sdg    <- 'GHG emissions per year' ## ton/yr
ind_ft     <- 'GHG' ## ton
unit_check <- 1000

### Check the Unit!!!
### rel --> kt = 1000 ton
### oft --> ton


### Resource consumption or emissions under the current trading world situation --------------------
xls   <- list.files(path = dir.input1, pattern = '^Total greenhouse gas emissions', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame() ## the status data 
### Consumption/emission (unit = kt) in real world
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  ## kt = 1000 ton
  as.data.frame()
  

### Outsourced footprints (oft) flow ---------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  ------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = oft, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value +      0),
    value_not = (value + net_in)) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)

### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_13_2_2 <- df_score

```


  **13.2.s** CO2 emissions intensity of areas under forest management.
  
  - *???* need to further look into the calculation of this indicator, as the calculation is different from the Xu et al 2020 NS paper. 
  
```{r - 13.2.s co2/forest}
ind_sdg    <- 'CO2 per area of forest' ## ton/ha
ind_ft     <- 'Landuse_forest'         ## ha
unit_check <- 100 

### Check the Unit!!!
### rel --> km2 = 100 ha (forest area data from world bank)
### oft --> ha           (embodied forest area from Eora)
### co2 --> ton


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Forest area', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%  # forest area in real world
  merge(x = ., y = oft,          by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = co2_rel_not,  by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    value_rel = var_rel/(value -      0),   ## (co2 in real world) / (forest area in real world)
    # value_not = var_not/(value - net_in),   ## (co2 if no trade)   / (forest area if no trade)
    value_not = var_not/(value -       0),  ## in 2020 NS paper, we use this calculation. (???)
    ind       = unique(oft$ind)) %>%        
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)



### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_13_2_s <- df_score


### for later use ---------------
forest_rel_not <- rel %>%
  merge(x = ., y = oft, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind     = unique(oft$ind),
    var_rel = (value +      0),
    var_not = (value - net_in)) %>% ## if no trade, a net importer would have less forest 
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, var_rel, var_not)
```




### SDG 14

#### - 14.1.1x Eutrophication - N

  **14.1.1** Index of coastal eutrophication
  
  Fertilizers Use per area of cropland (kg/ha), which can be a proxy of coastal *eutrophication*.
  
```{r}
ind_sdg  <- 'Eutrophication - N Use per area of cropland' ## kg/ha
ind_ft   <- 'NitrogenNWP'

### Check the Unit!!!
### rel            --> kg/ha
### oft            --> ton = 1000 kg
### cropland_area  --> ha


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Nutrient nitrogen N', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value)) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in*1000) %>%  ## 1 ton = 1000 kg
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = cropland_area, by = c('iso3', 'year'), all.x = T) %>%  
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>% 
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value),                                          ## kg/ha
    value_not = (value*cropland_area + net_in)/cropland_area) %>%  ## kg/ha * ha / ha
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_14_1_1x <- df_score
```


#### - 14.1.1y Eutrophication - P

  Fertilizers Use per area of cropland (kg/ha), which can be a proxy of coastal *eutrophication*.
  
```{r}
ind_sdg  <- 'Eutrophication - P Use per area of cropland' ## kg/ha
ind_ft   <- 'Phosphorusirriwater'

### Check the Unit!!!
### rel            --> kg/ha
### oft            --> kton = 10^6 kg
### cropland_area  --> ha


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Nutrient phosphate P2O5', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = as.numeric(value)) %>%  
  as.data.frame()
  

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == ind_ft) %>%
  dplyr::mutate(net_in = net_in*10^6) %>%  ## 1 kton = 10^6 kg
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = cropland_area, by = c('iso3', 'year'), all.x = T) %>%  
  merge(x = ., y = oft,           by = c('iso3', 'year'), all.x = T) %>% 
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (value),                                           ## kg/ha
    value_not = (value*cropland_area + net_in)/cropland_area) %>%  ## kg/ha * ha / ha
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()


score_14_1_1y <- df_score
```




### SDG 15 

  15.1.1 Forest area as a proportion of total land area (high value indicates high SDG ind_sdg score)	
```{r - 15.1.1 forest/total land}
ind_sdg  <- 'forest_percent' ## m3/m3
unit_check <- 100 

### Check the Unit!!!
### rel --> km2
### oft --> ha
### total  --> km2 m3


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area:  `land_total`; total land does not change
### --> forest footprint: `forest_rel_not`

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- merge(x = land_total, y = forest_rel_not,  by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    value_rel = var_rel/(land_total_km2 * 100),      ## forest area/ total land area
    value_not = var_not/(land_total_km2 * 100)) %>%  ## total land area does not change
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)




### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_15_1_1 <- df_score
```







  
  15.2.1 Progress towards sustainable forest management (forest area net change rate as a measure)	
  - forest change = (forest_t - forest_0)/forest_0
```{r - 15.2.1 forest change}
ind_sdg  <- 'forest_change' ## ha/ha
unit_check <- 100 

### Check the Unit!!!
### rel --> km2  ## 1 km = 100 ha
### oft --> ha


### Resource consumption or emissions under the current trading world situation -------------------------
xls <- list.files(path = dir.input1, pattern = '^Forest area', full.names = T); xls 
rel_w <- readxl::read_excel(path = xls) %>% as.data.frame()  ## the status data
rel <- rel_w %>%
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value = value*unit_check) %>%  
  as.data.frame()
  

### choose the base line year - 2000
base <- rel %>% 
  dplyr::filter(year == 2000) %>%
  dplyr::mutate(`2000` = value, `2005` = `2000`, `2010` = `2000`, `2015` = `2000`) %>%
  dplyr::select(-year, -value) %>%
  gather(key = 'year', value = 'base', `2000`:ncol(.))
  

### or choose 1990 as the baseline year ------------------------------------------------------------
# xls <- list.files(path = dirname(dir.input1), pattern = '^Forest area', full.names = T); xls 
# base <- readxl::read_excel(path = xls) %>% 
#   as.data.frame() %>%
#   dplyr::select(iso3_eora, country_eora, `1990`)  %>%
#   dplyr::rename(iso3 = `iso3_eora`, ctr = `country_eora`) %>%
#   arrange(iso3) %>%
#   dplyr::mutate(`2000` = `1990`, `2005` = `1990`, `2010` = `1990`, `2015` = `1990`) %>%
#   dplyr::select(- `1990`, -ctr) %>%
#   gather(key = 'year', value = 'base', `2000`:ncol(.))  %>%
#   as.data.frame()


### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = base,           by = c('iso3', 'year'), all.x = T) %>%
  merge(x = ., y = forest_rel_not, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (var_rel - base)/base,
    value_not = (var_not - base)/base) %>%
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)




### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_15_2_1 <- df_score
```





### SDG 16


  16.2.2 Number of victims of human trafficking per 100,000 population, by sex, age and form of exploitation
  **NNED ATTENTION!!!**
    *0 is the best, large positive and negative are both bad*
    *Is there a need to divide population number?*
    
```{r - 16.2.2 human_trafficking}

ind_sdg    <- 'human_trafficking' ## person
unit_check <- 1

### Check the Unit!!!
### rel --> 
### oft --> person

### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'human_trafficking') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)


### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- oft %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (0 - net_in),  ## net exports as the measurement
    value_not = (0 - 0)) %>%   ## 0 transfer under no-trade
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)


### normalization  --------------------------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_16_2_2 <- df_score
```




  16.4.2 Proportion of seized, found or surrendered arms whose illicit origin or context has been traced or established by a competent authority in line with international instruments
  - Exports of major conventional weapons (TIV constant million USD per 100,000 population)
 
 
  SIPRI has developed a unique system to measure the volume of international transfers of major conventional weapons using a common unit, the *trend-indicator value (TIV)*.
  The TIV is based on the known unit production costs of a core set of weapons and is intended *to represent the transfer of military resources* rather than the financial value of the transfer.
  
  **NNED ATTENTION!!!**
    *0 is the best, large positive and negative are both bad*
    *Is there a need to divide population number?*
 
```{r - 16.4.2 arms trade}
ind_sdg  <- 'arms_trade' ## TIV
unit_check <- 1

### Check the Unit!!!
### rel --> 
### oft --> TIV



### Outsourced footprints (oft) flow --------------------------------------------------------------------
oft <- net_imports_bind  %>%
  dplyr::filter(ind == 'arms_trade') %>%
  dplyr::select(ind, year, iso3, net_in, scenario) %>%
  spread(key = scenario, value = net_in)



### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- oft %>%
  merge(x = ., y = pop_l, by = c('iso3', 'year'), all.x = T) %>%
  dplyr::mutate(
    ind       = unique(oft$ind),
    value_rel = (0 - net_in),  ## net exports as the measurement
    value_not = (0 - 0)) %>%   ## 0 transfer under no-trade
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, net_in, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)




### normalization  --------------------------------------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_bad(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_16_4_2 <- df_score
```




### SDG 17

#### - 17.3.1x FDI/GDP

  **17.3.1** Foreign direct investment as a proportion of gross national income
  
  - Since this indicator underline 'cooperation', the *absolute value* should be used. 

```{r}

ind_sdg  <- 'FDI per GDP' ## 

### Check the Unit!!!
### rel --> USD
### oft --> NA
### gdp --> USD


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Foreign direct investment, net inflows', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value     = as.numeric(value),
                value_abs = abs(value)) %>%  ## since this indicator underline 'cooperation', the absolute value should be used. 
  as.data.frame()
  

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = gdp_rel_not,  by = c('iso3', 'year'), all.x = T) %>% ## total land
  dplyr::mutate(
    ind       = 'Foreign direct investment',
    value_rel = (value_abs            )/gdp_rel,  ## 
    value_not = (value_abs - value_abs)/gdp_not) %>%  ## cropland area under no-trade
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_17_3_1x <- df_score
```




#### - 17.3.1y ODA/GDP

  *17.3.1* Official development assistance as a proportion of gross national income
  
  - Since this indicator underline 'cooperation', the *absolute value* should be used. 

```{r}
ind_sdg  <- 'ODA per GDP' ## 

### Check the Unit!!!
### rel --> USD
### oft --> NA
### gdp --> USD


### Resource consumption or emissions under the current trading world situation -------------------------
### --> total land area
xls <- list.files(path = dir.input1, pattern = '^Net official development assistance and official aid', full.names = T); xls 
rel <- readxl::read_excel(path = xls) %>% 
  dplyr::select(-ctr) %>%
  gather(key = 'year', value = 'value', `2000`:ncol(.)) %>%
  dplyr::mutate(value     = as.numeric(value),
                value_abs = abs(value)) %>%  ## since this indicator underline 'cooperation', the absolute value should be used. 
  as.data.frame()
  

### w/o trade, and with trade together  -----------------------------------------------------------------
rel_not_merge <- rel %>%
  merge(x = ., y = gdp_rel_not,  by = c('iso3', 'year'), all.x = T) %>% ## total land
  dplyr::mutate(
    ind       = 'Foreign direct investment',
    value_rel = (value_abs            )/gdp_rel,  ## 
    value_not = (value_abs - value_abs)/gdp_not) %>%  ## cropland area under no-trade
  ### for easy-checking the numbers
  dplyr::select(ind, iso3, year, value, everything())

rel_not <- rel_not_merge %>%
  dplyr::select(ind, iso3, year, value_rel, value_not)

hist(rel_not$value_rel)


### normalization  -------------------------------------------------------
### Be careful with **Data Direction!**
### big - better? --> func_norm_sdg_score_good
### big - bad?    --> func_norm_sdg_score_bad
df_score <- func_norm_sdg_score_good(df = rel_not, trim = 0.025, bottom = 0.05, top = 0.95) %>%
  # spread(key = 'scenario', value = c('value_norm')) %>%
  dplyr::mutate(ind_sdg = ind_sdg) %>%
  as.data.frame()

score_17_3_1y <- df_score
```




### All SDGs
```{r}
dfs <- do.call(rbind, mget(ls(pattern="^score_"))) %>%
  dplyr::mutate(rowId = row.names(.),
                rowId = gsub('score\\_', '', rowId))  %>%
  separate(col = rowId, into = c('sdg_ind', 'num_id'), sep = '\\.', remove = T) %>%
  dplyr::select(-num_id) %>%
  separate(col = sdg_ind, into = c('goal', 'target', 'indicator'), sep = '\\_', remove = F) %>%
  dplyr::mutate(target = paste0(goal, '_', target)) %>%
  as.data.frame()

unique(dfs$sdg_ind) %>% sort()
unique(dfs$goal) %>% as.numeric() %>% sort()


save(dfs, file = './Data/data_03_results/SDGs_all.RData')
```



# Plot

```{r Colors}
### create map colors for score change
colors_changes <- c(
  ## brown
  '#f44343', 
  '#f46d43',
  '#feb24c',
  '#ffeda0',
  
  ## blues
  '#eff3ff', '#c6dbef', '#6baed6', '#4292c6' ## option1
  # '#e0f3f8', '#abd9e9', '#74add1', '#4575b4' ## option2

)
```


## SDG Score & Index

### Score
```{r - bar - change by Goal}

### load data
load('./Data/data_03_results/SDGs_all.RData') ## --> `dfs`

dfs_score <- dfs %>%
  ungroup() %>%
  dplyr::select(-val) %>%
  dplyr::filter(year == 2015) %>%
  group_by(iso3, year, scenario, goal) %>%
  dplyr::summarise(score = mean(value_norm, na.rm = TRUE))


### for each country, to what extent each goal was impacted by metacouplings? 
dfs_score_chg <- dfs_score %>%
  spread(key = scenario, value = score) %>%
  dplyr::mutate(value_chg = value_rel - value_not, 
                value_chg = ifelse(value_chg >= 20,  20, value_chg),
                value_chg = ifelse(value_chg <=-20, -20, value_chg),
                value_chg = ifelse(iso3 =='GRL', NA, value_chg)) %>%
  dplyr::select(-value_not, -value_rel) %>%
  dplyr::filter(year == 2015) %>%
  as.data.frame()

vars <- unique(dfs_score_chg$goal) %>% as.numeric() %>% sort() %>% as.character(); vars


### for each country, how many goals improved from metacouplings?
dfs_score_chg_count <- dfs_score_chg %>%
  # dplyr::filter() %>%
  dplyr::group_by(iso3) %>%
  dplyr::summarise(counts = sum(value_chg > 0, na.rm = TRUE),
                   counts_na = sum(is.na(value_chg))) %>%
  dplyr::filter(counts_na < 17/2) %>%  ## remove countries with too many NA
  dplyr::mutate(percent_increase = counts/17*100) %>%
  as.data.frame()





### Bar plot - Goal score change - by goal ---------------------------------------------------------

chg_err  <- dfs_score_chg %>% 
  # dplyr::filter(group_2 != 'na') %>%
  summarySE(measurevar= "value_chg", groupvars = c("year", "goal"), na.rm = T)

mycol <-  scale_fill_manual(values=c("#9ecae1", "#6baed6", "#3182bd", "#08519c"))


p <- ggplot(data = chg_err, 
            aes(y = factor(goal, levels = rev(vars)),
                x = value_chg, fill = value_chg > 0)) +
  geom_bar(position = position_dodge(0.8), stat="identity", width = 0.8, show.legend = F)+
  geom_errorbar(aes(xmin=value_chg-se, xmax=value_chg+se), 
                width=.3, 
                position=position_dodge(.8)) +
  xlab("Impact on SDG score")+ ylab('SDGs') + labs(fill = "Goal")+
  theme_bw() +
  theme(plot.margin = unit(c(0.1, 0, 0.1, -.5), "cm"))+ 
  theme(legend.position = c(0.1, 0.85), 
        axis.ticks.y = element_blank(),
        # panel.grid.major = , 
        # axis.text.y = element_blank(),
        panel.grid.minor = element_blank())
p
# fname <- paste0(dir.fig, 'SDG_score_chg_errorBar.jpg'); fname
# ggsave(filename = fname, plot = last_plot(), width = 3, height = 5, units = 'in', dpi = 300)




### SDG icons --------------------------------------------------------------------------------------

### read in SDG icons 
getwd()
image_png <- sort(sample(dir("../SDG_icons/UN/SDG-Icons-2019_WEB", 
                            full.names = TRUE), 17))
image_png
img_sur <- "../SDG_icons/UN/SDG-Icons-2019_WEB/E-WEB-Goal-"


### make the image strip ----------------- 
### SDG icon order: top->down: 17->1
sdg_id   <- seq(1,17,1); sdg_id
sdg_id.y <- sdg_id - 0.5; sdg_id.y  ## - 0.5
### reverse the order: top->down: 1->17
sdg_id.y <- rev(sdg_id.y); sdg_id.y
scale_here <- 0.9

icons <- axis_canvas(plot = p, axis = 'y') + 
  draw_image(paste0(img_sur, '01', '.png'), y = sdg_id.y[1], scale = scale_here) +
  draw_image(paste0(img_sur, '02', '.png'), y = sdg_id.y[2], scale = scale_here) +
  draw_image(paste0(img_sur, '03', '.png'), y = sdg_id.y[3], scale = scale_here) +
  draw_image(paste0(img_sur, '04', '.png'), y = sdg_id.y[4], scale = scale_here) +
  draw_image(paste0(img_sur, '05', '.png'), y = sdg_id.y[5], scale = scale_here) +
  draw_image(paste0(img_sur, '06', '.png'), y = sdg_id.y[6], scale = scale_here) +
  draw_image(paste0(img_sur, '07', '.png'), y = sdg_id.y[7], scale = scale_here) +
  draw_image(paste0(img_sur, '08', '.png'), y = sdg_id.y[8], scale = scale_here) +
  draw_image(paste0(img_sur, '09', '.png'), y = sdg_id.y[9], scale = scale_here) +
  draw_image(paste0(img_sur, 10, '.png'),   y = sdg_id.y[10], scale = scale_here) +
  draw_image(paste0(img_sur, 11, '.png'),   y = sdg_id.y[11], scale = scale_here) +
  draw_image(paste0(img_sur, 12, '.png'),   y = sdg_id.y[12], scale = scale_here) +
  draw_image(paste0(img_sur, 13, '.png'),   y = sdg_id.y[13], scale = scale_here) +
  draw_image(paste0(img_sur, 14, '.png'),   y = sdg_id.y[14], scale = scale_here) +
  draw_image(paste0(img_sur, 15, '.png'),   y = sdg_id.y[15], scale = scale_here) +
  draw_image(paste0(img_sur, 16, '.png'),   y = sdg_id.y[16], scale = scale_here) +
  draw_image(paste0(img_sur, 17, '.png'),   y = sdg_id.y[17], scale = scale_here) #+
  # draw_image(paste0(img_sur, 18, '.png'), y = 18-.5, scale = scale_here)

### insert the image strip into the bar plot and draw  
p_icon <- ggdraw(insert_yaxis_grob(plot = p, grob = icons, grid::unit(.1, "null"), position = "left"))
# p_icon

fname <- paste0(dir.fig, '01main/SDG_score_chg_Bar_ICON.jpg'); fname
ggsave(filename = fname, plot = p_icon, width = 6, height = 8, units = 'in', dpi = 600)

## ref: https://www.rdocumentation.org/packages/cowplot/versions/1.1.1/topics/axis_canvas
```




```{r - bar - change by Goal by county group}
df_shp <- shp %>%
  merge(x = ., y = dfs_score_chg, by.x = 'iso_a3', by.y = 'iso3', all.x = T) %>%
  st_drop_geometry() %>% 
  dplyr::mutate(
    group = tm::removeNumbers(income_grp),
    group = gsub(":.*", "", group),
    group = gsub("(?!\\:)[[:punct:]]", "", group, perl=TRUE),
    group = stringr::str_squish(group),
    group = factor(x = group, levels = c("High income", "Upper middle income", "Lower middle income", "Low income")),
    group = fct_rev(group)) %>%
  as.data.frame()


chg_err_group  <- df_shp %>% 
  dplyr::filter(year != 'na') %>%
  summarySE(measurevar= "value_chg", groupvars = c("year", 'group', "goal"), na.rm = T)

# show_col(brewer_pal(palette = "Blues")(5))
color_grp <- brewer_pal(palette = "Blues")(5)[2:5]; color_grp
color_grp <- (color_grp) ## rev(color_grp)


ggplot(data = chg_err_group, 
       aes(x=factor(goal, levels = rev(vars)),
           y = value_chg,
           fill = group)) +
  geom_bar(position = position_dodge(0.8), stat="identity", width = 0.8, show.legend = T)+
  geom_errorbar(aes(ymin=value_chg-se, ymax=value_chg+se), 
                width=.3, 
                position=position_dodge(.8)) +
  ylab("Impact on SDG score") + xlab('SDGs') + labs(fill = "Group")+
  # scale_fill_brewer(palette = "Blues", direction = -1) +
  scale_fill_manual(values = color_grp, guide = guide_legend(reverse = TRUE)) +
  coord_flip()+
  
  theme_bw() +
  theme(legend.position = c(0.15, 0.06), 
        # legend.key.size = unit(0.2,"cm"), 
        legend.key.width = unit(0.3,"cm"), 
        legend.key.height = unit(0.2,"cm"),
        panel.grid.minor = element_blank())

fname <- paste0(dir.fig, '01main/SDG_score_chg_Bar_byGroup.jpg'); fname
ggsave(filename = fname, plot = last_plot(), width = 6, height = 8, units = 'in', dpi = 300)

```




```{r - map of 17 SDGs change}

df_chg <- dfs_score_chg %>%
  spread(key = goal, value = value_chg)

ind_sdg <- 'SDG Score change'

### plot -------------------------------------------------------------------------------------------
df_chg_sf  <- df_chg %>%
  merge(x = shp, y = ., by.x = "iso_a3", by.y = "iso3",  all.y = T)

col_tmap <- colors_changes
title_ls <- paste0('SDG ', vars); title_ls

fname <- paste0(dir.fig, '01main/SDG_score_chg_Map_byGoal.jpg'); fname
jpeg(filename = fname, width=7, height=6, units="in", pointsize=18, res=500) ## width=7, height=4 --> ncol=4

tm_shape(df_chg_sf) +
  tm_fill(vars, 
    # 'value_chg',
          palette = col_tmap, #col1,
          style = "fixed",
          breaks=c(-Inf, -20, -10, -5, 0, 5, 10, 20, Inf),
          labels = c("< -20", "[-20, -10)", "[-10, -5]", "(-5, 0)", "[0, 5)", "[5, 10]", "(10, 20]", "> 20"), 
          title = title_ls, textNA = 'NA', colorNA = 'gray95',
          legend.reverse = T) +
  tm_borders(col = "grey", lwd = 0.1, lty = "solid", alpha = 0.99) +
  tm_layout(frame = T, frame.lwd = 0.1, 
    legend.position = c(0,0),
    legend.title.size = 0.9,
    legend.text.size  = 0.7,
    # legend.format = list(text.less.than = '<', text.or.more = "<", text.separator = "~"),
    legend.width = -0.7,
    legend.height = -0.7, 
    
    panel.show = F) +
  tm_facets(ncol=3)

dev.off()
```




```{r - map of the # of increased SDGs}

### plot -------------------------------------------------------------------------------------------
df_chg_sf  <- dfs_score_chg_count %>%
  merge(x = shp, y = ., by.x = "iso_a3", by.y = "iso3",  all.y = T)

col_tmap <- colors_changes
col_tmap <- brewer.pal(n = 10, name = "PiYG")

fname <- paste0(dir.fig, '01main/SDG_score_count_Improved.jpg'); fname
jpeg(filename = fname, width=7, height=2.8, units="in", pointsize=18, res=300)

tm_shape(df_chg_sf) +
  tm_fill(col = 'percent_increase', 
          palette = col_tmap, #col1,
          style = "fixed",
          breaks= seq(0, 100, 10),
          title = '% of improved\nSDGs',
          textNA = 'NA', colorNA = 'gray95',
          legend.reverse = T) +
  tm_borders(col = "grey", lwd = 0.1, lty = "solid", alpha = 0.99) +
  tm_layout(
    frame = F, frame.lwd = 0.1, 
    legend.position = c(0,0),
    legend.title.size = 0.9,
    legend.text.size  = 0.7,
    # legend.format = list(text.less.than = '<', text.or.more = "<", text.separator = "~"),
    legend.width = -0.7,
    legend.height = -0.7, 
    outer.margins=0, #c(0,0.001, 0, 0.001), #  bottom, left, top, and right
    inner.margins=0,
    panel.show = F) 

dev.off()
```



### Index
```{r}
### SDG Index --------------------------------------------------------------------------------------
dfs_index <- dfs_score %>%
  ungroup() %>%
  group_by(iso3, year, scenario) %>%
  dplyr::summarise(index = mean(score, na.rm = TRUE))


dfs_index %>%
  ungroup() %>%
  group_by(scenario) %>%
  dplyr::summarise(index_mean = mean(index, na.rm = TRUE),
                   index_sd   = sd(index, na.rm = TRUE))
  


### SDG Index change -------------------------------------------------------------------------------
dfs_index_chg <- dfs_index %>%
  spread(key = scenario, value = index) %>%
  dplyr::mutate(value_chg = value_rel - value_not, 
                value_chg = ifelse(value_chg >= 20,  20, value_chg),
                value_chg = ifelse(value_chg <=-20, -20, value_chg),
                value_chg = ifelse(iso3 =='GRL', NA, value_chg)) %>%
  dplyr::filter(year == 2015) %>%
  as.data.frame()
        

dfs_index_chg_pct <- dfs_index_chg %>%
  dplyr::filter(!is.na(value_not) & value_not != 0) %>%
  dplyr::mutate(value_chg_pct = value_chg/value_not*100)
summary(dfs_index_chg_pct$value_chg_pct, na.rm = T) # 20.2% increase on average


hist(dfs_index_chg_pct$value_chg)
boxplot(dfs_index_chg_pct$value_chg)

quantile(dfs_index_chg_pct$value_chg, na.rm = T)
summary(dfs_index_chg_pct$value_chg)
sd(dfs_index_chg_pct$value_chg, na.rm = T)
```



```{r - map of index for 2 scenarios}
dfs_index_sf <- dfs_index %>%
  spread(key = scenario, value = index) %>%
  merge(x = shp, y = ., by.x = "iso_a3", by.y = "iso3",  all.y = T)


### plot 
fname <- paste0(dir.fig, '01main/SDG_Index_Map_Baseline + Lockdown.jpg'); fname
jpeg(filename = fname, width=7, height=2.8*2, units="in", pointsize=18, res=500)

tm_shape(dfs_index_sf) +
  tm_fill(c('value_rel', 'value_not'),
          palette = 'YlGn', 
          style = "fixed",
          ## "cat", "fixed", "sd", "equal", "pretty", "quantile", "kmeans", "hclust", "bclust", "fisher", "jenks"
          # stretch.palette = T,
          breaks = c(0, seq(50, 100, by = 10)),
          # labels = seq(0, 100, by = 10),
          title  = c('SDG Index\n(Baseline)', 'SDG Index\n(Global lockdown)'),
          textNA = 'NA', colorNA = 'gray90',
          legend.reverse = T) +
  tm_borders(col = "white", lwd = 0.1, lty = "solid", alpha = 0.99) +
  tm_layout(frame = F, frame.lwd = 0.1,
    legend.position = c(0,0),
    legend.title.size = 0.7,
    legend.text.size  = 0.5,
    legend.width = -0.5,
    legend.height = -0.5,
    outer.margins=0, inner.margins=0,
    panel.show = F) +
  tm_facets(free.scales.fill = F, ncol = 1)

dev.off()
```



```{r - map of Index change}
df_chg <- dfs_index_chg %>%
  dplyr::select(-value_not, -value_rel)


### plot -------------------------------
df_chg_sf  <- df_chg %>%
  merge(x = shp, y = ., by.x = "iso_a3", by.y = "iso3",  all.y = T)

seq <- c(-20, -10, -5, 0, 5, 10, 20); seq; length(seq)
labels.legend <- seq
# Colour Palette; one value to one color
col_tmap <- colors_changes

fname <- paste0(dir.fig, '01main/SDG_Index_chg_Map.jpg'); fname
jpeg(filename = fname, width=7, height=2.8, units="in", pointsize=18, res=300)

tm_shape(df_chg_sf) +
  tm_fill('value_chg',
          palette = col_tmap, #col1,
          style = "fixed",
          breaks=c(-Inf, -20, -10, -5, 0, 5, 10, 20, Inf),
          labels = c("< -20", "[-20, -10)", "[-10, -5]", "(-5, 0)", "[0, 5)", "[5, 10]", "(10, 20]", "> 20"), 
          title = 'Impact on\nSDG Index' , 
          textNA = 'NA', colorNA = 'gray90',
          legend.reverse = T) +
  tm_borders(col = "grey", lwd = 0.1, lty = "solid", alpha = 0.99) +
  tm_layout(frame = F, frame.lwd = 0.1,
    legend.position = c(0,0),
    legend.title.size = 0.7,
    legend.text.size  = 0.5,
    legend.width = -0.5,
    legend.height = -0.5,
    outer.margins=0, inner.margins=0,
    panel.show = F)

dev.off()
```



```{r - boxplot - change by income group}
dfs_index_chg %>%
  merge(., grp, by.x = 'iso3', by.y = 'iso_a3', all.x = T) %>%
  dplyr::mutate(
    group = factor(x = group, levels = c("High income", "Upper middle income", "Lower middle income", "Low income"))) %>%
  filter(!is.na(group)) %>%
  
ggplot(aes(x= group, y=value_chg, group = group, 
           fill = group,
           color = group)) + 
  geom_boxplot(outlier.shape = NA, notch = T, fill = NA, show.legend = F) + 
  geom_point(position=position_jitterdodge(jitter.width = 0.5),
             # aes(fill = group), shape = 21, 
             # color = 'gray30',
             alpha = 0.6, show.legend = F) +
  # scale_color_brewer(palette = "Blues", direction = -1, na.value = 'black') +
  scale_colour_manual(values = brewer.pal(n = 6, "Blues")[6:3]) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_hline(yintercept = 0, color="red", linetype="dashed") +
  xlab('') + ylab('Impact on SDG Index')
  
fname <- paste0(dir.fig, '01main/Extend_fig_SDG_Index_chg_byGroup.jpg'); fname
ggsave(filename = fname, plot = last_plot(), width = 6, height = 6, units = 'in', dpi = 300)
```




```{r - Index change summary}

### how many countries improved SDG Index? ---------------------------------------------------------
df_chg_sf_count <- df_chg_sf %>%
  st_drop_geometry() %>%
  merge(x=., y=pop_l %>% dplyr::filter(year==2015) %>% dplyr::select(-year), by.x='iso_a3', by.y='iso3', all.x=T) %>%
  dplyr::filter(!is.na(value_chg)) %>%
  dplyr::filter(!is.na(income_grp)) %>%
  dplyr::mutate(increase = ifelse(value_chg > 0, 1, 0),
                increase_pop = increase*pop)



## 1. number and % of country improved SDG index?
sum(df_chg_sf_count$increase, na.rm = T)                 ## 171
sum(df_chg_sf_count$increase)/nrow(df_chg_sf_count)*100  ## 91%

## 2. number and % of population improved SDG Index?
total_pop <- sum(df_chg_sf_count$pop, na.rm = T); total_pop
total_pop_increased <- sum(df_chg_sf_count$increase_pop, na.rm = T); total_pop_increased
total_pop_increased/total_pop*100


## 3. for countries with decreased SDG Index, how many are low-income and what it the % ?
df_chg_sf_count_lowincome <- df_chg_sf_count %>%
  dplyr::filter(increase < 1) %>%
  dplyr::filter(!is.na(income_grp)) %>%
  dplyr::mutate(low_income = ifelse(stringr::str_detect(fixed(pattern = 'low', ignore_case = T), string = income_grp), 1, 0)) %>%
  as.data.frame()
  
sum(df_chg_sf_count_lowincome$low_income, na.rm = T)                                      ## 13    are low-income 
sum(df_chg_sf_count_lowincome$low_income, na.rm = T)/nrow(df_chg_sf_count_lowincome)*100  ## 76.5% are low-income
```





### Indicator

  Map each SDG Indicator score under the two scenarios, i.e., baseline and lock down, for comparison. 
  
  *Note*: this won't be included in the manuscript, but is useful for data inspection or being used in SI. 
  
```{r - map scores, eval=FALSE, include=FALSE}

### 1. choose one indicator

str(dfs)

unique(dfs$sdg_ind)
unique(dfs$ind_sdg)

ind_sdg_i <- 'gdp_per_water'


df_score <- dfs %>%
  ungroup() %>%
  as.data.frame() %>%
  dplyr::filter(ind_sdg == ind_sdg_i)

ind_sdg_id <- df_score %>%
  distinct(sdg_ind) %>% unlist()
ind_sdg_id


### look at the data distribution ----------------------------------------
ggplot(df_score, aes(x = val)) +
  geom_histogram(bins = 30) +
  facet_wrap(~year) +
  theme_bw() +
  ggtitle(ind_sdg_i)

ggplot(df_score, aes(x = value_norm)) +
  geom_histogram(bins = 30) +
  facet_wrap(~year) +
  theme_bw() +
  ggtitle(ind_sdg_i)



### map plot eora -------------------------------------------------------------------------------------
df_sf  <- df_score %>%
  dplyr::select(-val) %>%
  # dplyr::filter(year == 2015) %>%
  merge(x = shp, y = ., by.x = "iso_a3", by.y = "iso3",  all.y = T) 

### any countries failed to be joined? --> ANT, SUN, SUN --> which are expected. 
df_sf_na <- df_sf %>%
  dplyr::filter(is.na(name))

map <- ggplot(data = df_sf) +
  geom_sf(aes(fill = value_norm), size = 0.1, color = "grey90") +
  scale_fill_viridis(direction = -1, na.value = "grey95") +
  facet_grid(year~scenario, switch = 'y')+ ## switch = 'y' ## --> label to be displaced on the left
  theme_bw() +
  theme_map
fname <- paste0(dir.fig, 'map_each_SDG_indicator_score/', 'map_SDG_2scenarios_', ind_sdg_id, '_', ind_sdg_i, '.jpg'); fname
ggsave(filename = fname, plot = map, width = 7, height = 5, units = 'in', dpi = 300)
```




```{r - map score change, eval=FALSE, include=FALSE}
df_chg <- df_score %>%
  dplyr::select(-val) %>%
  spread(key = scenario, value = value_norm) %>%
  dplyr::mutate(value_chg = value_rel - value_not, 
         value_chg = ifelse(value_chg >= 20,  20, value_chg),
         value_chg = ifelse(value_chg <=-20, -20, value_chg),
         value_chg = ifelse(iso3 =='GRL', NA, value_chg)) %>%
  dplyr::select(-value_not, -value_rel) %>%
  dplyr::filter(year == 2015) %>%
  as.data.frame()

hist(df_chg$value_chg)



df_chg_sf  <- df_chg %>%
  merge(x = shp, y = ., by.x = "iso_a3", by.y = "iso3",  all.y = T)


seq <- c(-20, -10, -5, 0, 5, 10, 20); seq; length(seq)
labels.legend <- seq
# Colour Palette; one value to one color


### 1. using ggplot --> not that good
# ggplot(data = df_chg_sf) +
#   geom_sf(aes(fill = value_chg), size = 0.1, color = "grey90") +
#   # scale_fill_viridis(direction = -1, na.value = "grey20") +
#   scale_fill_gradient2(
#     low = "red", mid = "white", high = "blue",
#     midpoint = 0, space = "Lab", na.value = "grey95", guide = "colourbar",
#     aesthetics = "fill")+
#   # scale_fill_gradientn(colors=colors_changes, breaks=seq, na.value ='gray70', limits=c(-20, 20)) +
#   # guides(fill = guide_legend(label.hjust = 1, label = T))+
#   # facet_wrap(~goal)+
#   theme_bw() +
#   theme_map



fname <- paste0(dir.fig, 'map_each_SDG_indicator_score/', 'map_SDG_score_chg_', ind_sdg_id, '_', ind_sdg_i, '.jpg'); fname
     


### 2. using tmap --> good!
col_tmap <- colors_changes

jpeg(filename = fname, width=7, height=4, units="in", pointsize=18, res=300)

tm_shape(df_chg_sf) +
  tm_fill(#sdgs_list,          # tm_polygons; tm_fill
    'value_chg',
          palette = col_tmap, #col1,
          style = "fixed",
          breaks=c(-Inf, -20, -10, -5, 0, 5, 10, 20, Inf),
          labels = c("< -20", "[-20, -10)", "[-10, -5]", "(-5, 0)", "[0, 5)", "[5, 10]", "(10, 20]", "> 20"), 
          title = ind_sdg , textNA = 'NA', colorNA = 'gray95',
          legend.reverse = T) +
  tm_borders(col = "grey90", lwd = 0.1, lty = "solid", alpha = 0.99) +
  tm_layout(frame = T, frame.lwd = 0.1,
    legend.position = c(0,0),
    legend.title.size = 0.7,
    legend.text.size  = 0.5,
    
    # legend.format = list(text.less.than = '<', text.or.more = "<",
    #                      text.separator = "~"),
    legend.width = -0.5,
    legend.height = -0.5,
    
    panel.show = F)

dev.off()
```





```{r - map compare with WIOD, eval=FALSE, include=FALSE}
### map plot wiod ----------------------------------------------------------------------------------
### for comparison  
pattern <- paste0('normalized_score__', ind_sdg , '.RData'); pattern
fname <- list.files(path = 'G:/My Drive/_paper/SDGs/SDGs_Global_Trade', 
                    recursive = T, full.names = T,
                    pattern = pattern); fname
# length(fname) 
# nchar(fname)

if (length(fname) > 0) {
  load(fname)
  df_wiod <- normalized_score %>%
    ### format data
    dplyr::filter(scenario %in% c('rel_c', 'not_c')) %>%
    dplyr::select(nation, scenario, '2000', '2005', '2009') %>% 
    gather(key = 'year', value = 'value_norm',   `2000`:ncol(.)) %>%
    as.data.frame() %>%
    ### join with shp
    merge(x = shp_wiod, y = ., by.x = "iso_a3", by.y = "nation",  all.y = T) %>%
    ### We remove the ROW data here for better comparison with the Eora data. 
    dplyr::mutate(value_norm = ifelse(iso_a3 == 'ROW', NA, value_norm))
  
  # unique(df_wiod$iso_a3)
  # names(df_wiod)
  
  ggplot(data = df_wiod) +
    geom_sf(aes(fill = value_norm), size = 0.1, color = "grey90") +
    scale_fill_viridis(direction = -1, na.value = "grey95") +
    facet_grid(year~scenario, switch = 'y')+ ## switch = 'y' ## --> label to be displaced on the left
    theme_bw() +
    theme_map  
  fname <- paste0(dir.fig, 'map_each_SDG_indicator_score/', 'map_SDG_2scenarios_', ind_sdg_id, '_', ind_sdg_i, '_wiod.jpg'); fname
  ggsave(filename = fname, plot = last_plot(), width = 7, height = 4, units = 'in', dpi = 300)
} else {
  print('No such data')
}

```

















# ===================================
# MC: distant vs. nearby

  *How to determine?*
  
  1. Boolean (0 or 1) to determine Distant vs. nearby matrix
  
  
    |      | ctr1 | ctr2 | ctr3  | ... |
    --------------------------------------
    | ctr1 |  1   |   1  |    0  |     |
    | ctr2 |  1   |   1  |    0  |     |
    | ctr3 |  0   |   0  |    0  |     |
    | ...  |      |      |       |     |
    
    
  2. Quantitative euclidean distance to determine Distant vs. nearby matrix 
  
  
    |      | ctr1 | ctr2 | ctr3  | ... |
    --------------------------------------
    | ctr1 |    1 | 100  |  900  |     |
    | ctr2 |  100 |   1  |  300  |     |
    | ctr3 |  900 | 300  |    1  |     |
    | ...  |      |      |       |     |
    
    Then, if
        d < 100,    nearby,  truck
        d < 1000,   distant, train/ship
        else,       distant, flight?
    
```{r eval=FALSE, include=FALSE}
Net_Import_Cal <- function(df.xlsx, matrix) {
  # trade matrix
  s1 <- read_excel(df.xlsx, sheet = 1, col_names = T, range = "B1:AP616")
  s2 <- matrix
  
  # nearby trade matrix
  s3 <- s1 * s2
  
  # add country name as a new col
  countries <- colnames(s2[1:41])
  colnames(s3) <- countries; length(countries)
  
  # add year seq to data frame 
  year_seq = rep(seq(1995, 2009, by=1), each = 41)
  s3$year <- year_seq
  
  # total nearby imports
  s4 <- s3 %>% group_by(year) %>% summarise_all(funs(sum))
  
  # tanspose data frame and keep the first col as new header
  s5 = as.data.frame(t(s4[,-1]))
  colnames(s5) <- seq(1995, 2009, by=1)
  s5 <- s5[ order(row.names(s5)), ]
  
  # total nearby exports
  library("reshape2") # expand long table to wide one
  s6 <- s3 %>%
    mutate(row.sum   = rowSums(s3[,1:41]),
           year      = year_seq,
           countries = rep(countries, times = 15)) %>% # times=15, each = 15
    dcast(countries ~ year, value.var = 'row.sum') # year as new col names
  s6 <- data.frame(s6[,-1], row.names=s6[,1])
  s6 <- s6[ order(row.names(s6)), ]
  
  # net nearby imports
  s7 <- s5 - s6
}


# load spatial relation: nearby or distant
ner_dst_matrix <- "./_input_data/_adjancet_distant_matrix.xlsx"
ner.matrix <- read_excel(path = ner_dst_matrix, sheet = 'S2.country_nearby',  col_names = T, range = "B1:AP616")
dst.matrix <- read_excel(path = ner_dst_matrix, sheet = 'S2.country_distant', col_names = T, range = "B1:AP616")
not.matrix <- read_excel(path = ner_dst_matrix, sheet = 'S2.country_not',     col_names = T, range = "B1:AP616")

# cal using function
s7.ner <- Net_Import_Cal(df.xlsx, matrix = ner.matrix)
s7.dst <- Net_Import_Cal(df.xlsx, matrix = dst.matrix)
s7.not <- Net_Import_Cal(df.xlsx, matrix = not.matrix)
```





